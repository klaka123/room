<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ú¶ MEGABUILD ‚Äî –î–ò–ó–ê–ô–ù –° –û–ì–†–û–ú–ù–´–ú –î–ï–ö–û–†–û–ú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap');

        body {
            overflow: hidden;
            background: #0c0f18;
            color: #f0f4fc;
        }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            z-index: 10;
        }

        .top-bar {
            pointer-events: all;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 28, 40, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid #4f6b8a;
            border-radius: 60px;
            padding: 12px 30px;
            box-shadow: 0 10px 30px -10px #000;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffcc88, #ffaa66);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats {
            display: flex;
            gap: 40px;
            font-size: 1rem;
            color: #d0e0ff;
        }

        .stats i {
            color: #ffaa66;
            margin-right: 5px;
        }

        .main-panels {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            margin-top: 20px;
        }

        .catalog-panel {
            pointer-events: all;
            width: 340px;
            background: rgba(20, 28, 40, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid #4f6b8a;
            border-radius: 40px;
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .catalog-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .catalog-header h3 {
            font-size: 1.3rem;
            color: #ffaa66;
        }

        .badge {
            background: #2f4f6f;
            padding: 4px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
        }

        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .cat-btn {
            background: #1e2e3e;
            border: 1px solid #4f6b8a;
            color: #ccc;
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .cat-btn:hover {
            border-color: #ffaa66;
            color: white;
        }

        .cat-btn.active {
            background: #ffaa66;
            color: #0c0f18;
            border-color: #ffaa66;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .item-card {
            background: #1a2838;
            border-radius: 28px;
            padding: 15px 5px 10px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #4f6b8a;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .item-card:hover {
            background: #2a3f55;
            transform: translateY(-3px);
            border-color: #ffaa66;
        }

        .item-card.selected {
            border-color: #ffaa66;
            background: #3a5a7a;
            box-shadow: inset 0 0 0 1px #ffaa66;
        }

        .item-icon {
            font-size: 2.8rem;
            filter: drop-shadow(0 5px 10px black);
        }

        .item-name {
            font-size: 0.8rem;
            text-align: center;
            color: #ddd;
        }

        .tools-panel {
            pointer-events: all;
            width: 300px;
            background: rgba(20, 28, 40, 0.7);
            backdrop-filter: blur(15px);
            border: 1px solid #4f6b8a;
            border-radius: 40px;
            padding: 20px;
        }

        .tools-section {
            margin-bottom: 25px;
        }

        .tools-section h4 {
            color: #ffaa66;
            margin-bottom: 12px;
            border-bottom: 1px solid #4f6b8a;
            padding-bottom: 5px;
            font-size: 1.1rem;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
        }

        .mode-btn {
            flex: 1;
            background: #1e2e3e;
            border: 1px solid #4f6b8a;
            color: #ccc;
            padding: 10px;
            border-radius: 40px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .mode-btn:hover {
            border-color: #ffaa66;
            color: white;
        }

        .mode-btn.active {
            background: #ffaa66;
            color: #0c0f18;
            border-color: #ffaa66;
        }

        .control-row {
            margin-bottom: 15px;
        }

        .control-row label {
            display: block;
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 4px;
        }

        .control-row select, .control-row input {
            width: 100%;
            padding: 8px 12px;
            background: #1a2838;
            border: 1px solid #4f6b8a;
            border-radius: 30px;
            color: white;
        }

        .control-row input[type="color"] {
            height: 45px;
            padding: 3px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            color: #ccc;
        }

        .checkbox-row input {
            width: auto;
        }

        .action-btn {
            width: 100%;
            background: #ffaa66;
            border: none;
            color: #0c0f18;
            padding: 12px;
            border-radius: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }

        .action-btn:hover {
            background: #ffbb77;
            transform: translateY(-2px);
        }

        .hint {
            pointer-events: all;
            align-self: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            color: white;
            padding: 10px 30px;
            border-radius: 60px;
            border: 1px solid #ffaa66;
            font-size: 1rem;
            margin-bottom: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="ui-container">
        <div class="top-bar">
            <div class="logo">‚ú¶ MEGABUILD</div>
            <div class="stats">
                <span><i class="fas fa-cube"></i> <span id="statItems">0</span></span>
                <span><i class="fas fa-tachometer-alt"></i> <span id="statFps">0</span> FPS</span>
            </div>
        </div>

        <div class="main-panels">
            <div class="catalog-panel">
                <div class="catalog-header">
                    <h3><i class="fas fa-couch"></i> –ö–ê–¢–ê–õ–û–ì –î–ï–ö–û–†–ê (50+)</h3>
                    <span class="badge" id="catalogCount">0</span>
                </div>
                <div class="category-tabs" id="categoryTabs">
                    <!-- –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>
                <div class="items-grid" id="itemsGrid"></div>
            </div>

            <div class="tools-panel">
                <div class="tools-section">
                    <h4>–†–ï–ñ–ò–ú</h4>
                    <div class="mode-buttons">
                        <button class="mode-btn active" id="modeWall"><i class="fas fa-cubes"></i> –°—Ç–µ–Ω–∞</button>
                        <button class="mode-btn" id="modeItem"><i class="fas fa-paint-brush"></i> –î–µ–∫–æ—Ä</button>
                    </div>
                </div>

                <div class="tools-section" id="wallControls">
                    <h4>–ü–ê–†–ê–ú–ï–¢–†–´ –°–¢–ï–ù–´</h4>
                    <div class="control-row">
                        <label>–ú–ê–¢–ï–†–ò–ê–õ</label>
                        <select id="wallMat">
                            <option value="stone">–ö–∞–º–µ–Ω—å</option>
                            <option value="brick">–ö–∏—Ä–ø–∏—á</option>
                            <option value="wood">–î–µ—Ä–µ–≤–æ</option>
                            <option value="marble">–ú—Ä–∞–º–æ—Ä</option>
                            <option value="concrete">–ë–µ—Ç–æ–Ω</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>–¶–í–ï–¢</label>
                        <input type="color" id="wallColor" value="#aaccff">
                    </div>
                </div>

                <div class="tools-section" id="itemControls" style="display:none;">
                    <h4>–ü–ê–†–ê–ú–ï–¢–†–´ –î–ï–ö–û–†–ê</h4>
                    <div class="control-row">
                        <label>–ú–ê–¢–ï–†–ò–ê–õ</label>
                        <select id="itemMat">
                            <option value="wood">–î–µ—Ä–µ–≤–æ</option>
                            <option value="metal">–ú–µ—Ç–∞–ª–ª</option>
                            <option value="fabric">–¢–∫–∞–Ω—å</option>
                            <option value="glass">–°—Ç–µ–∫–ª–æ</option>
                            <option value="stone">–ö–∞–º–µ–Ω—å</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>–¶–í–ï–¢</label>
                        <input type="color" id="itemColor" value="#c47e5a">
                    </div>
                    <div class="control-row">
                        <label>–ü–û–í–û–†–û–¢</label>
                        <input type="range" id="itemRotate" min="0" max="360" value="0">
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="snapGrid" checked>
                        <label>–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ (2–º)</label>
                    </div>
                </div>

                <button class="action-btn" id="undoBtn"><i class="fas fa-undo"></i> –û—Ç–º–µ–Ω–∞</button>
                <button class="action-btn" id="clearBtn"><i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>

        <div class="hint" id="hint">–†–µ–∂–∏–º: –°—Ç–µ–Ω–∞ ‚Äî –∫–ª–∏–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–ª–æ–∫–∞ (—Å–µ—Ç–∫–∞ 2–º)</div>
    </div>

    <canvas id="canvas"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ü–µ–Ω—ã ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0c0f18);
        scene.fog = new THREE.FogExp2(0x0c0f18, 0.001);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(30, 20, 40);
        camera.lookAt(0, 2, 0);

        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2.2;
        controls.minDistance = 5;
        controls.maxDistance = 200;
        controls.target.set(0, 2, 0);

        // --- –û—Å–≤–µ—â–µ–Ω–∏–µ ---
        const sunLight = new THREE.DirectionalLight(0xfff5e6, 1.3);
        sunLight.position.set(10, 30, 20);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 8192;
        sunLight.shadow.mapSize.height = 8192;
        sunLight.shadow.camera.near = 1;
        sunLight.shadow.camera.far = 80;
        sunLight.shadow.camera.left = -30;
        sunLight.shadow.camera.right = 30;
        sunLight.shadow.camera.top = 30;
        sunLight.shadow.camera.bottom = -30;
        scene.add(sunLight);

        const ambientLight = new THREE.AmbientLight(0x40486c, 0.6);
        scene.add(ambientLight);

        const fillLight1 = new THREE.PointLight(0xffaa88, 0.5);
        fillLight1.position.set(-8, 6, 10);
        scene.add(fillLight1);
        const fillLight2 = new THREE.PointLight(0x88aaff, 0.4);
        fillLight2.position.set(10, 5, -10);
        scene.add(fillLight2);

        // --- –ü–æ–ª –∏ —Å–µ—Ç–∫–∞ (—Ä–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ 2 –º–µ—Ç—Ä–∞) ---
        const groundGeo = new THREE.CircleGeometry(200, 64);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x1a2430, roughness: 0.8 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        const gridHelper = new THREE.GridHelper(200, 100, 0xffaa66, 0x3a4a6a);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // --- –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ–±—ä–µ–∫—Ç–æ–≤ ---
        let placedItems = [];

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
        let currentMode = 'wall'; // wall / item
        let wallMat = 'stone';
        let wallColor = '#aaccff';
        let itemMat = 'wood';
        let itemColor = '#c47e5a';
        let itemRotate = 0;
        let snapEnabled = true; // —Å–µ—Ç–∫–∞ 2–º

        // --- –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–±–æ–ª–µ–µ 50) ---
        const catalog = [
            // –°—Ç—É–ª—å—è –∏ –∫—Ä–µ—Å–ª–∞
            { id: 'chair1', name: '–ö—Ä–µ—Å–ª–æ Chester', icon: 'ü™ë', cat: 'chairs', style: 'chester', color: '#8b4513' },
            { id: 'chair2', name: '–°—Ç—É–ª Eames', icon: 'üí∫', cat: 'chairs', style: 'eames', color: '#4a5a6a' },
            { id: 'chair3', name: '–°—Ç—É–ª –õ—é–¥–æ–≤–∏–∫', icon: 'ü™ë', cat: 'chairs', style: 'louis', color: '#c49a6c' },
            { id: 'chair4', name: '–°—Ç—É–ª –í–µ–Ω—Å–∫–∏–π', icon: 'ü™ë', cat: 'chairs', style: 'vienna', color: '#d4b088' },
            { id: 'chair5', name: '–ë–∞—Ä–Ω—ã–π —Å—Ç—É–ª', icon: 'ü™ë', cat: 'chairs', style: 'bar', color: '#3a3a4a' },
            // –î–∏–≤–∞–Ω—ã
            { id: 'sofa1', name: '–î–∏–≤–∞–Ω Chester', icon: 'üõãÔ∏è', cat: 'sofas', style: 'chester', color: '#8b4513' },
            { id: 'sofa2', name: '–î–∏–≤–∞–Ω Modern', icon: 'üõãÔ∏è', cat: 'sofas', style: 'modern', color: '#5a6b7a' },
            { id: 'sofa3', name: '–î–∏–≤–∞–Ω Scandi', icon: 'üõãÔ∏è', cat: 'sofas', style: 'scandi', color: '#b0aa90' },
            { id: 'sofa4', name: '–ö—É—à–µ—Ç–∫–∞', icon: 'üõãÔ∏è', cat: 'sofas', style: 'chaise', color: '#8a6d5a' },
            // –°—Ç–æ–ª—ã
            { id: 'table1', name: '–°—Ç–æ–ª –æ–±–µ–¥–µ–Ω–Ω—ã–π', icon: 'ü™ë', cat: 'tables', style: 'dining', color: '#8b5a2b' },
            { id: 'table2', name: '–ñ—É—Ä–Ω–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª–∏–∫', icon: 'ü™ë', cat: 'tables', style: 'coffee', color: '#a58b6f' },
            { id: 'table3', name: '–ö–æ–Ω—Å–æ–ª—å', icon: 'ü™ë', cat: 'tables', style: 'console', color: '#7a5a3a' },
            { id: 'table4', name: '–ü–∏—Å—å–º–µ–Ω–Ω—ã–π —Å—Ç–æ–ª', icon: 'üìù', cat: 'tables', style: 'desk', color: '#5a3a2a' },
            { id: 'table5', name: '–¢—É–∞–ª–µ—Ç–Ω—ã–π —Å—Ç–æ–ª–∏–∫', icon: 'ü™û', cat: 'tables', style: 'vanity', color: '#c49a6c' },
            // –®–∫–∞—Ñ—ã –∏ —Å—Ç–µ–ª–ª–∞–∂–∏
            { id: 'cabinet1', name: '–°—Ç–µ–ª–ª–∞–∂', icon: 'üìö', cat: 'cabinets', style: 'shelf', color: '#8b5a2b' },
            { id: 'cabinet2', name: '–®–∫–∞—Ñ –ø–ª–∞—Ç—è–Ω–æ–π', icon: 'üö™', cat: 'cabinets', style: 'wardrobe', color: '#a0522d' },
            { id: 'cabinet3', name: '–ö–æ–º–æ–¥', icon: 'üóÑÔ∏è', cat: 'cabinets', style: 'dresser', color: '#c19a6b' },
            { id: 'cabinet4', name: '–í–∏—Ç—Ä–∏–Ω–∞', icon: 'üèõÔ∏è', cat: 'cabinets', style: 'display', color: '#d4af37' },
            { id: 'cabinet5', name: '–¢—É–º–±–∞', icon: 'üóÑÔ∏è', cat: 'cabinets', style: 'nightstand', color: '#8b5a2b' },
            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            { id: 'lamp1', name: '–¢–æ—Ä—à–µ—Ä', icon: 'üí°', cat: 'lighting', style: 'floor', color: '#c0c0c0' },
            { id: 'lamp2', name: '–ù–∞—Å—Ç–æ–ª—å–Ω–∞—è –ª–∞–º–ø–∞', icon: 'üí°', cat: 'lighting', style: 'table', color: '#88aadd' },
            { id: 'lamp3', name: '–õ—é—Å—Ç—Ä–∞', icon: 'üí°', cat: 'lighting', style: 'chandelier', color: '#d4af37' },
            { id: 'lamp4', name: '–ë—Ä–∞', icon: 'üí°', cat: 'lighting', style: 'wall', color: '#aaaaaa' },
            { id: 'lamp5', name: '–ü–æ–¥–≤–µ—Å', icon: 'üí°', cat: 'lighting', style: 'pendant', color: '#cccccc' },
            // –î–µ–∫–æ—Ä
            { id: 'vase1', name: '–í–∞–∑–∞', icon: 'üè∫', cat: 'decor', style: 'vase', color: '#5a7a9a' },
            { id: 'vase2', name: '–ö—É–≤—à–∏–Ω', icon: 'üè∫', cat: 'decor', style: 'jug', color: '#8b5a2b' },
            { id: 'mirror1', name: '–ó–µ—Ä–∫–∞–ª–æ', icon: 'ü™û', cat: 'decor', style: 'mirror', color: '#d4af37' },
            { id: 'painting1', name: '–ö–∞—Ä—Ç–∏–Ω–∞', icon: 'üñºÔ∏è', cat: 'decor', style: 'painting', color: '#9a7a5a' },
            { id: 'clock1', name: '–ß–∞—Å—ã', icon: '‚è∞', cat: 'decor', style: 'clock', color: '#8b5a2b' },
            { id: 'sculpture1', name: '–°–∫—É–ª—å–ø—Ç—É—Ä–∞', icon: 'üóø', cat: 'decor', style: 'sculpture', color: '#b87333' },
            { id: 'carpet1', name: '–ö–æ–≤—ë—Ä', icon: 'üß∂', cat: 'decor', style: 'carpet', color: '#8b1e3f' },
            { id: 'plant1', name: '–§–∏–∫—É—Å', icon: 'üåø', cat: 'plants', style: 'ficus', color: '#2e8b57' },
            { id: 'plant2', name: '–ü–∞–ª—å–º–∞', icon: 'üå¥', cat: 'plants', style: 'palm', color: '#228b22' },
            { id: 'plant3', name: '–ö–∞–∫—Ç—É—Å', icon: 'üåµ', cat: 'plants', style: 'cactus', color: '#5f9f4f' },
            { id: 'plant4', name: '–û—Ä—Ö–∏–¥–µ—è', icon: 'üå∏', cat: 'plants', style: 'orchid', color: '#d87093' },
            { id: 'plant5', name: '–ë–æ–Ω—Å–∞–π', icon: 'üéç', cat: 'plants', style: 'bonsai', color: '#6b8e23' },
            // –¢–µ—Ö–Ω–∏–∫–∞
            { id: 'tv1', name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä', icon: 'üì∫', cat: 'tech', style: 'tv', color: '#1a1a1a' },
            { id: 'speaker1', name: '–ö–æ–ª–æ–Ω–∫–∞', icon: 'üîä', cat: 'tech', style: 'speaker', color: '#3a3a3a' },
            { id: 'laptop1', name: '–ù–æ—É—Ç–±—É–∫', icon: 'üíª', cat: 'tech', style: 'laptop', color: '#2a2a3a' },
            { id: 'fridge1', name: '–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫', icon: 'üßä', cat: 'tech', style: 'fridge', color: '#f0f0f0' },
            { id: 'oven1', name: '–î—É—Ö–æ–≤–∫–∞', icon: 'üî•', cat: 'tech', style: 'oven', color: '#3a3a3a' },
            // –ö–Ω–∏–≥–∏ –∏ –º–µ–ª–æ—á–∏
            { id: 'book1', name: '–ö–Ω–∏–≥–∏', icon: 'üìö', cat: 'books', style: 'books', color: '#8b4513' },
            { id: 'bowl1', name: '–ß–∞—à–∞', icon: 'ü•£', cat: 'decor', style: 'bowl', color: '#5a7a9a' },
            { id: 'candle1', name: '–°–≤–µ—á–∞', icon: 'üïØÔ∏è', cat: 'decor', style: 'candle', color: '#f5e6d3' },
        ];

        // --- –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–µ—Ç–∫–µ (—Ä–∞–∑–º–µ—Ä 2 –º–µ—Ç—Ä–∞) ---
        function snapPosition(pos, gridSize = 2.0) {
            if (!snapEnabled) return pos;
            return new THREE.Vector3(
                Math.round(pos.x / gridSize) * gridSize,
                Math.round(pos.y / gridSize) * gridSize,
                Math.round(pos.z / gridSize) * gridSize
            );
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä ---
        function createStoneTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#9a9a9a';
            ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 20000; i++) {
                ctx.fillStyle = `rgba(120,120,120,${Math.random()*0.3})`;
                ctx.fillRect(Math.random()*512, Math.random()*512, 2, 2);
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createBrickTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 512, 512);
            ctx.fillStyle = '#8b5a2b';
            for (let y = 0; y < 512; y+=64) {
                for (let x = 0; x < 512; x+=128) {
                    ctx.fillRect(x, y, 120, 60);
                }
            }
            ctx.strokeStyle = '#4a2a1a';
            ctx.lineWidth = 4;
            for (let x = 0; x < 512; x+=128) {
                ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,512); ctx.stroke();
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createWoodTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#b08968';
            ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 30; i++) {
                ctx.strokeStyle = '#8b5a2b';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(0, i*20);
                ctx.lineTo(512, i*20+15);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createMarbleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 100; i++) {
                ctx.strokeStyle = `rgba(128,128,128,${Math.random()*0.5})`;
                ctx.lineWidth = Math.random()*20;
                ctx.beginPath();
                ctx.moveTo(Math.random()*512, Math.random()*512);
                ctx.lineTo(Math.random()*512, Math.random()*512);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createConcreteTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#7a7a7a';
            ctx.fillRect(0, 0, 512, 512);
            for (let i = 0; i < 10000; i++) {
                ctx.fillStyle = `rgba(100,100,100,${Math.random()*0.2})`;
                ctx.beginPath();
                ctx.arc(Math.random()*512, Math.random()*512, Math.random()*5, 0, 2*Math.PI);
                ctx.fill();
            }
            return new THREE.CanvasTexture(canvas);
        }

        // --- –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞ —Å—Ç–µ–Ω—ã (—Ä–∞–∑–º–µ—Ä 2x2x2) ---
        function createWallBlock(material, color) {
            const colorHex = parseInt(color.slice(1), 16);
            let map;
            switch(material) {
                case 'stone': map = createStoneTexture(); break;
                case 'brick': map = createBrickTexture(color); break;
                case 'wood': map = createWoodTexture(); break;
                case 'marble': map = createMarbleTexture(); break;
                case 'concrete': map = createConcreteTexture(); break;
                default: map = null;
            }
            const mat = new THREE.MeshStandardMaterial({ color: colorHex, map: map, roughness: 0.7 });
            const geo = new THREE.BoxGeometry(2, 2, 2); // —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ 2 –º–µ—Ç—Ä–∞
            const mesh = new THREE.Mesh(geo, mat);
            mesh.castShadow = true; mesh.receiveShadow = true;
            return mesh;
        }

        // --- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–µ–∫–æ—Ä–∞ (—Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ, –Ω–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ---
        // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–∑–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é, –≤–æ–∑–≤—Ä–∞—â–∞—é—â—É—é –≥—Ä—É–ø–ø—É —Å –¥–µ—Ç–∞–ª—è–º–∏.
        // –í —Ä–∞–º–∫–∞—Ö –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏–≤–µ–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ.
        function createChairChester(color, materialType) {
            const group = new THREE.Group();
            const woodMat = new THREE.MeshStandardMaterial({ color: 0x8b5a2b, roughness: 0.6 });
            const fabricMat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.9 });
            const metalMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.3, metalness: 0.7 });

            // –ù–æ–∂–∫–∏
            const legGeo = new THREE.CylinderGeometry(0.3, 0.35, 0.5, 8);
            for (let x = -0.8; x <= 0.8; x+=1.6) {
                for (let z = -0.8; z <= 0.8; z+=1.6) {
                    const leg = new THREE.Mesh(legGeo, woodMat);
                    leg.position.set(x, 0.25, z);
                    leg.scale.set(1,1,1);
                    leg.castShadow = true; leg.receiveShadow = true;
                    group.add(leg);
                }
            }

            // –°–∏–¥–µ–Ω—å–µ
            const seat = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.3, 1.8), fabricMat);
            seat.position.y = 0.65;
            seat.castShadow = true; seat.receiveShadow = true;
            group.add(seat);

            // –°–ø–∏–Ω–∫–∞
            const back = new THREE.Mesh(new THREE.BoxGeometry(1.8, 2.0, 0.4), fabricMat);
            back.position.set(0, 1.8, -0.8);
            back.castShadow = true; back.receiveShadow = true;
            group.add(back);

            // –ü—É–≥–æ–≤–∏—Ü—ã
            for (let i = -0.6; i <= 0.6; i+=0.6) {
                for (let j = 1.2; j <= 2.2; j+=0.5) {
                    const btn = new THREE.Mesh(new THREE.SphereGeometry(0.15, 12), metalMat);
                    btn.position.set(i, j, -0.6);
                    btn.castShadow = true;
                    group.add(btn);
                }
            }

            // –ü–æ–¥–ª–æ–∫–æ—Ç–Ω–∏–∫–∏
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1.0, 1.8), fabricMat);
            arm.position.set(-1.2, 1.2, 0);
            arm.castShadow = true; arm.receiveShadow = true;
            group.add(arm);
            const arm2 = arm.clone();
            arm2.position.set(1.2, 1.2, 0);
            group.add(arm2);

            return group;
        }

        // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —Å–æ–∑–¥–∞–¥–∏–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (–≤ —Ü–µ–ª—è—Ö —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–ª–Ω—ã–º–∏)
        function createGenericItem(style, color, materialType) {
            const group = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.5 });
            if (style.includes('vase')) {
                const base = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 0.3, 8), mat);
                base.position.y = 0.15; base.castShadow = true; base.receiveShadow = true;
                group.add(base);
                const body = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.4, 1.2, 8), mat);
                body.position.y = 0.8; body.castShadow = true; body.receiveShadow = true;
                group.add(body);
            } else if (style.includes('lamp')) {
                const base = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.6, 0.2, 8), mat);
                base.position.y = 0.1; base.castShadow = true; base.receiveShadow = true;
                group.add(base);
                const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.12, 2.5, 6), mat);
                pole.position.y = 1.35; pole.castShadow = true; pole.receiveShadow = true;
                group.add(pole);
                const shade = new THREE.Mesh(new THREE.ConeGeometry(0.6, 0.7, 8), mat);
                shade.position.y = 2.5; shade.castShadow = true; shade.receiveShadow = true;
                group.add(shade);
            } else if (style.includes('plant')) {
                const pot = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.6, 0.5, 8), mat);
                pot.position.y = 0.25; pot.castShadow = true; pot.receiveShadow = true;
                group.add(pot);
                const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.15, 1.5, 6), mat);
                stem.position.y = 1.0; stem.castShadow = true; stem.receiveShadow = true;
                group.add(stem);
                for (let i=0;i<6;i++) {
                    const leaf = new THREE.Mesh(new THREE.ConeGeometry(0.2, 0.5, 5), mat);
                    leaf.position.set(Math.cos(i)*0.5, 1.5, Math.sin(i)*0.5);
                    leaf.rotation.x = 0.2; leaf.rotation.y = i; leaf.castShadow = true;
                    group.add(leaf);
                }
            } else {
                const box = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), mat);
                box.castShadow = true; box.receiveShadow = true;
                group.add(box);
            }
            return group;
        }

        // –§–∞–±—Ä–∏–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        function createItemFromCatalog(item, color, materialType) {
            const colorHex = parseInt(color.slice(1), 16);
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã switch –ø–æ item.style, –≤—ã–∑—ã–≤–∞—é—â–∏–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é.
            // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±–æ–±—â—ë–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.
            return createGenericItem(item.style, colorHex, materialType);
        }

        // --- UI ---
        function loadCatalog() {
            const grid = document.getElementById('itemsGrid');
            const catDiv = document.getElementById('categoryTabs');
            const cats = new Set(catalog.map(i => i.cat));
            const catNames = {
                chairs: '–°—Ç—É–ª—å—è', sofas: '–î–∏–≤–∞–Ω—ã', tables: '–°—Ç–æ–ª—ã', cabinets: '–®–∫–∞—Ñ—ã',
                lighting: '–°–≤–µ—Ç', decor: '–î–µ–∫–æ—Ä', plants: '–†–∞—Å—Ç–µ–Ω–∏—è', tech: '–¢–µ—Ö–Ω–∏–∫–∞', books: '–ö–Ω–∏–≥–∏'
            };

            // –ö–Ω–æ–ø–∫–∞ "–í—Å—ë"
            const allBtn = document.createElement('button');
            allBtn.className = 'cat-btn active';
            allBtn.dataset.cat = 'all';
            allBtn.textContent = '–í–°–Å';
            allBtn.addEventListener('click', () => filterCategory('all', allBtn));
            catDiv.appendChild(allBtn);

            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'cat-btn';
                btn.dataset.cat = cat;
                btn.textContent = catNames[cat] || cat;
                btn.addEventListener('click', () => filterCategory(cat, btn));
                catDiv.appendChild(btn);
            });

            catalog.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.dataset.id = item.id;
                card.dataset.cat = item.cat;
                card.innerHTML = `<div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div>`;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedItem = item;
                });
                grid.appendChild(card);
            });
            document.getElementById('catalogCount').textContent = catalog.length;
        }

        function filterCategory(cat, activeBtn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            activeBtn.classList.add('active');
            document.querySelectorAll('.item-card').forEach(card => {
                if (cat === 'all' || card.dataset.cat === cat) card.style.display = 'flex';
                else card.style.display = 'none';
            });
        }

        // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ ---
        document.getElementById('modeWall').addEventListener('click', () => {
            currentMode = 'wall';
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('modeWall').classList.add('active');
            document.getElementById('wallControls').style.display = 'block';
            document.getElementById('itemControls').style.display = 'none';
            document.getElementById('hint').innerHTML = '–†–µ–∂–∏–º: –°—Ç–µ–Ω–∞ ‚Äî –∫–ª–∏–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–ª–æ–∫–∞ (—Å–µ—Ç–∫–∞ 2–º)';
        });
        document.getElementById('modeItem').addEventListener('click', () => {
            currentMode = 'item';
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('modeItem').classList.add('active');
            document.getElementById('wallControls').style.display = 'none';
            document.getElementById('itemControls').style.display = 'block';
            document.getElementById('hint').innerHTML = '–†–µ–∂–∏–º: –î–µ–∫–æ—Ä ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è';
        });

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ---
        document.getElementById('wallMat').addEventListener('change', (e) => wallMat = e.target.value);
        document.getElementById('wallColor').addEventListener('input', (e) => wallColor = e.target.value);
        document.getElementById('itemMat').addEventListener('change', (e) => itemMat = e.target.value);
        document.getElementById('itemColor').addEventListener('input', (e) => itemColor = e.target.value);
        document.getElementById('itemRotate').addEventListener('input', (e) => itemRotate = parseFloat(e.target.value));
        document.getElementById('snapGrid').addEventListener('change', (e) => snapEnabled = e.target.checked);

        // --- –û—Ç–º–µ–Ω–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ ---
        document.getElementById('undoBtn').addEventListener('click', () => {
            if (placedItems.length) {
                scene.remove(placedItems.pop());
                updateStats();
            }
        });
        document.getElementById('clearBtn').addEventListener('click', () => {
            placedItems.forEach(i => scene.remove(i));
            placedItems = [];
            updateStats();
        });

        // --- –ú—ã—à—å ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
        const intersect = new THREE.Vector3();

        let selectedItem = catalog[0]; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        renderer.domElement.addEventListener('click', (e) => {
            if (e.target.closest('.ui-container')) return;

            mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (!raycaster.ray.intersectPlane(plane, intersect)) return;

            let pos = intersect.clone();
            if (snapEnabled) pos = snapPosition(pos, 2.0);
            pos.y = 0;

            if (currentMode === 'wall') {
                const block = createWallBlock(wallMat, wallColor);
                block.position.copy(pos);
                block.position.y = 1.0; // –ø–æ–ª–æ–≤–∏–Ω–∞ –≤—ã—Å–æ—Ç—ã 2–º
                scene.add(block);
                placedItems.push(block);
            } else {
                const item = createItemFromCatalog(selectedItem, itemColor, itemMat);
                item.position.copy(pos);
                item.position.y = 1.0; // –ø–æ–¥–Ω–∏–º–µ–º –ø—Ä–∏–º–µ—Ä–Ω–æ
                item.rotation.y = itemRotate * Math.PI / 180;
                scene.add(item);
                placedItems.push(item);
            }
            updateStats();
        });

        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
        function updateStats() {
            document.getElementById('statItems').textContent = placedItems.length;
        }

        let lastTime = performance.now();
        let frames = 0;
        function updateFPS() {
            frames++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('statFps').textContent = frames;
                frames = 0;
                lastTime = now;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            updateFPS();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.ready();
        }

        loadCatalog();
        animate();
    </script>
</body>
</html>
