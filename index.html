<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ú¶ MEGA DESIGN STUDIO ‚Äì –ü–û–õ–ù–û–ï –ü–û–ì–†–£–ñ–ï–ù–ò–ï</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            user-select: none;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap');

        body {
            overflow: hidden;
            background: #0a0c18;
            color: #f0f4fc;
        }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
        }

        .top-bar {
            pointer-events: all;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(25, 30, 40, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #ffaa66;
            border-radius: 60px;
            padding: 8px 20px;
            color: white;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffaa66;
        }

        .stats {
            display: flex;
            gap: 30px;
        }

        .main-panels {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex: 1;
            pointer-events: none;
        }

        .catalog-panel {
            pointer-events: all;
            width: 340px;
            background: rgba(25, 30, 40, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #ffaa66;
            border-radius: 40px;
            padding: 20px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .catalog-panel h3 {
            color: #ffaa66;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .item-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid #3a4a6a;
            border-radius: 30px;
            padding: 12px 5px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: 0.2s;
        }

        .item-card:hover {
            border-color: #ffaa66;
            background: rgba(50, 70, 100, 0.5);
            transform: translateY(-3px);
        }

        .item-card.selected {
            border-color: #ffaa66;
            background: rgba(255,170,102,0.2);
            box-shadow: 0 0 0 2px #ffaa66 inset;
        }

        .item-icon {
            font-size: 2rem;
        }

        .item-name {
            font-size: 0.7rem;
            color: #ddd;
            text-align: center;
        }

        .tools-panel {
            pointer-events: all;
            width: 320px;
            background: rgba(25, 30, 40, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #ffaa66;
            border-radius: 40px;
            padding: 20px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }

        .tools-panel h4 {
            color: #ffaa66;
            margin-bottom: 12px;
            border-bottom: 1px solid #3a4a6a;
            padding-bottom: 5px;
        }

        .mode-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .mode-btn {
            flex: 1 0 auto;
            background: #1e2a3a;
            border: 1px solid #3a4a6a;
            color: #ccc;
            padding: 6px 10px;
            border-radius: 30px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .mode-btn:hover {
            border-color: #ffaa66;
            color: white;
        }

        .mode-btn.active {
            background: #ffaa66;
            color: #0a0c1a;
            border-color: #ffaa66;
        }

        .control-row {
            margin: 12px 0;
        }

        .control-row label {
            display: block;
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 4px;
        }

        .control-row select, .control-row input {
            width: 100%;
            padding: 6px 10px;
            background: #1e2a3a;
            border: 1px solid #3a4a6a;
            border-radius: 30px;
            color: white;
        }

        .control-row input[type="color"] {
            height: 40px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            color: #ccc;
        }

        .action-btn {
            width: 100%;
            background: #ffaa66;
            border: none;
            color: #0a0c1a;
            padding: 10px;
            border-radius: 40px;
            font-weight: bold;
            cursor: pointer;
            margin: 6px 0;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            background: #ffbb77;
        }

        .hint-bar {
            pointer-events: all;
            align-self: center;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            color: white;
            padding: 10px 30px;
            border-radius: 60px;
            border: 1px solid #ffaa66;
            font-size: 0.85rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="ui-container">
        <div class="top-bar">
            <div class="logo">‚ú¶ MEGA DESIGN STUDIO</div>
            <div class="stats">
                <span><i class="fas fa-cube"></i> <span id="statItems">0</span></span>
                <span><i class="fas fa-tachometer-alt"></i> <span id="statFps">0</span> FPS</span>
            </div>
        </div>

        <div class="main-panels">
            <div class="catalog-panel">
                <h3><i class="fas fa-couch"></i> –ö–ê–¢–ê–õ–û–ì (30+)</h3>
                <div class="items-grid" id="catalogGrid"></div>
            </div>

            <div class="tools-panel">
                <div class="mode-buttons">
                    <button class="mode-btn active" id="modeWall">–°—Ç–µ–Ω–∞</button>
                    <button class="mode-btn" id="modeFloor">–ü–æ–ª/–ö—Ä—ã—à–∞</button>
                    <button class="mode-btn" id="modeItem">–ü—Ä–µ–¥–º–µ—Ç</button>
                </div>

                <div id="wallParams">
                    <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–µ–Ω—ã</h4>
                    <div class="control-row">
                        <label>–î–ª–∏–Ω–∞</label>
                        <input type="range" id="wallLength" min="0.5" max="10" step="0.5" value="3">
                    </div>
                    <div class="control-row">
                        <label>–í—ã—Å–æ—Ç–∞</label>
                        <input type="range" id="wallHeight" min="0.5" max="5" step="0.5" value="2.5">
                    </div>
                    <div class="control-row">
                        <label>–¢–æ–ª—â–∏–Ω–∞</label>
                        <input type="range" id="wallThick" min="0.1" max="1" step="0.1" value="0.2">
                    </div>
                    <div class="control-row">
                        <label>–¶–≤–µ—Ç</label>
                        <input type="color" id="wallColor" value="#aaccff">
                    </div>
                </div>

                <div id="floorParams" style="display:none;">
                    <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª–∞/–∫—Ä—ã—à–∏</h4>
                    <div class="control-row">
                        <label>–î–ª–∏–Ω–∞</label>
                        <input type="range" id="floorLength" min="1" max="20" step="0.5" value="5">
                    </div>
                    <div class="control-row">
                        <label>–®–∏—Ä–∏–Ω–∞</label>
                        <input type="range" id="floorWidth" min="1" max="20" step="0.5" value="5">
                    </div>
                    <div class="control-row">
                        <label>–¢–æ–ª—â–∏–Ω–∞</label>
                        <input type="range" id="floorThick" min="0.1" max="1" step="0.1" value="0.2">
                    </div>
                    <div class="control-row">
                        <label>–¶–≤–µ—Ç</label>
                        <input type="color" id="floorColor" value="#8b8b8b">
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="floorIsCeiling">
                        <label>–≠—Ç–æ –ø–æ—Ç–æ–ª–æ–∫ (–ø–æ–¥–Ω—è—Ç—å –Ω–∞ –≤—ã—Å–æ—Ç—É)</label>
                    </div>
                </div>

                <div id="itemParams" style="display:none;">
                    <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–∞</h4>
                    <div class="control-row">
                        <label>–¶–≤–µ—Ç</label>
                        <input type="color" id="itemColor" value="#c47e5a">
                    </div>
                    <div class="control-row">
                        <label>–ú–∞—Å—à—Ç–∞–±</label>
                        <input type="range" id="itemScale" min="0.5" max="2.5" step="0.1" value="1">
                    </div>
                    <div class="control-row">
                        <label>–ü–æ–≤–æ—Ä–æ—Ç</label>
                        <input type="range" id="itemRotate" min="0" max="360" step="5" value="0">
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="snapGrid" checked>
                        <label>–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ (0.5–º)</label>
                    </div>
                </div>

                <button class="action-btn" id="saveBtn"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="action-btn" id="loadBtn"><i class="fas fa-folder-open"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button class="action-btn" id="copyBtn"><i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å (Ctrl+D)</button>
                <button class="action-btn" id="deleteBtn"><i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å (Del)</button>
                <button class="action-btn" id="clearBtn"><i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                <p style="font-size:0.8rem; color:#aaa; text-align:center;">
                    WASD ‚Äì —Ö–æ–¥—å–±–∞ | –õ–ö–ú+–¥–≤–∏–∂–µ–Ω–∏–µ ‚Äì –æ—Å–º–æ—Ç—Ä<br>
                    G+–¥–≤–∏–∂–µ–Ω–∏–µ ‚Äì –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å | R+–¥–≤–∏–∂–µ–Ω–∏–µ ‚Äì –ø–æ–≤–µ—Ä–Ω—É—Ç—å
                </p>
            </div>
        </div>

        <div class="hint-bar" id="hint">–ö–ª–∏–∫ ‚Äì –≤—ã–¥–µ–ª–∏—Ç—å | G ‚Äì –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å | R ‚Äì –ø–æ–≤–µ—Ä–Ω—É—Ç—å | Ctrl+D ‚Äì –∫–æ–ø–∏—è | Del ‚Äì —É–¥–∞–ª–∏—Ç—å</div>
    </div>

    <canvas id="canvas"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- –°—Ü–µ–Ω–∞ ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0c18);
        scene.fog = new THREE.FogExp2(0x0a0c18, 0.0015);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(15, 5, 20);
        camera.lookAt(0, 2, 0);

        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        // –û—Ä–±–∏—Ç –∫–æ–Ω—Ç—Ä–æ–ª —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –¥–≤–∏–≥–∞—Ç—å –∫–∞–º–µ—Ä—É (–∏–º–∏—Ç–∞—Ü–∏—è —Ö–æ–¥—å–±—ã)
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2;
        controls.minDistance = 1;
        controls.maxDistance = 50;
        controls.target.set(0, 2, 0);
        controls.keys = { // –æ—Ç–∫–ª—é—á–∞–µ–º –∫–ª–∞–≤–∏—à–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            LEFT: 37, UP: 38, RIGHT: 39, BOTTOM: 40
        };
        controls.enablePan = true;
        controls.panSpeed = 1;

        // --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ WASD –¥–ª—è –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã ---
        const keyState = {
            w: false, a: false, s: false, d: false
        };
        document.addEventListener('keydown', (e) => {
            switch(e.code) {
                case 'KeyW': keyState.w = true; e.preventDefault(); break;
                case 'KeyA': keyState.a = true; e.preventDefault(); break;
                case 'KeyS': keyState.s = true; e.preventDefault(); break;
                case 'KeyD': keyState.d = true; e.preventDefault(); break;
            }
        });
        document.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW': keyState.w = false; e.preventDefault(); break;
                case 'KeyA': keyState.a = false; e.preventDefault(); break;
                case 'KeyS': keyState.s = false; e.preventDefault(); break;
                case 'KeyD': keyState.d = false; e.preventDefault(); break;
            }
        });

        // --- –û—Å–≤–µ—â–µ–Ω–∏–µ ---
        const sunLight = new THREE.DirectionalLight(0xfff5e6, 1.2);
        sunLight.position.set(5, 20, 10);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 4096;
        sunLight.shadow.mapSize.height = 4096;
        sunLight.shadow.camera.near = 1;
        sunLight.shadow.camera.far = 50;
        sunLight.shadow.camera.left = -15;
        sunLight.shadow.camera.right = 15;
        sunLight.shadow.camera.top = 15;
        sunLight.shadow.camera.bottom = -15;
        scene.add(sunLight);

        const ambient = new THREE.AmbientLight(0x40486c, 0.6);
        scene.add(ambient);

        const fillLight1 = new THREE.PointLight(0xffaa88, 0.5);
        fillLight1.position.set(-5, 5, 8);
        scene.add(fillLight1);
        const fillLight2 = new THREE.PointLight(0x88aaff, 0.4);
        fillLight2.position.set(6, 4, -6);
        scene.add(fillLight2);

        // --- –ü–æ–ª (–±–∞–∑–æ–≤—ã–π) –∏ —Å–µ—Ç–∫–∞ ---
        const groundGeo = new THREE.CircleGeometry(200, 64);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x2a2e3a, roughness: 0.8 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        const gridHelper = new THREE.GridHelper(200, 100, 0x333333, 0x333333);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        let placedObjects = [];
        let selectedObject = null;
        let currentMode = 'wall'; // wall, floor, item
        let snapEnabled = true;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç–µ–Ω—ã
        let wallLength = 3, wallHeight = 2.5, wallThick = 0.2;
        let wallColor = '#aaccff';

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª–∞/–∫—Ä—ã—à–∏
        let floorLength = 5, floorWidth = 5, floorThick = 0.2;
        let floorColor = '#8b8b8b';
        let floorIsCeiling = false;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–µ–¥–º–µ—Ç–∞
        let itemColor = '#c47e5a', itemScale = 1, itemRotate = 0;
        let selectedItemType = 'chester';

        // –î–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è/–≤—Ä–∞—â–µ–Ω–∏—è —Å –∫–ª–∞–≤–∏—à–∞–º–∏ G –∏ R
        let isDragging = false;
        let dragStart = new THREE.Vector2();
        let initialObjectPos = new THREE.Vector3();
        let initialObjectRot = 0;
        let currentAction = null; // 'move' –∏–ª–∏ 'rotate'

        document.addEventListener('keydown', (e) => {
            if (e.target.closest('input,select')) return;
            if (e.code === 'KeyG' && selectedObject) {
                currentAction = 'move';
                isDragging = true;
                dragStart.set(e.clientX, e.clientY);
                initialObjectPos.copy(selectedObject.position);
                e.preventDefault();
            }
            if (e.code === 'KeyR' && selectedObject) {
                currentAction = 'rotate';
                isDragging = true;
                dragStart.set(e.clientX, e.clientY);
                initialObjectRot = selectedObject.rotation.y;
                e.preventDefault();
            }
            if (e.code === 'Delete' && selectedObject) {
                scene.remove(selectedObject);
                placedObjects = placedObjects.filter(obj => obj !== selectedObject);
                highlightObject(null, false);
                selectedObject = null;
                updateStats();
            }
            if (e.ctrlKey && e.code === 'KeyD' && selectedObject) {
                e.preventDefault();
                const clone = selectedObject.clone();
                clone.position.x += 1;
                scene.add(clone);
                placedObjects.push(clone);
                selectedObject = clone;
                highlightObject(selectedObject, true);
                updateStats();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'KeyG' || e.code === 'KeyR') {
                isDragging = false;
                currentAction = null;
            }
        });

        // --- –í—ã–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–º ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', (e) => {
            if (e.target.closest('.ui-container')) return;
            mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(placedObjects, true);
            if (intersects.length > 0) {
                let obj = intersects[0].object;
                while (obj.parent && !placedObjects.includes(obj)) {
                    obj = obj.parent;
                }
                if (placedObjects.includes(obj)) {
                    selectedObject = obj;
                    highlightObject(selectedObject, true);
                } else {
                    highlightObject(null, false);
                    selectedObject = null;
                }
            } else {
                highlightObject(null, false);
                selectedObject = null;
            }
        });

        // --- –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ/–≤—Ä–∞—â–µ–Ω–∏–µ –º—ã—à—å—é ---
        renderer.domElement.addEventListener('mousemove', (e) => {
            if (!isDragging || !selectedObject) return;
            const dx = e.clientX - dragStart.x;
            const dy = e.clientY - dragStart.y;
            if (currentAction === 'move') {
                // –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ –ø–ª–æ—Å–∫–æ—Å—Ç–∏ XZ
                const speed = 0.01;
                selectedObject.position.x = initialObjectPos.x + dx * speed;
                selectedObject.position.z = initialObjectPos.z + dy * speed;
                if (e.shiftKey) {
                    // –≤–µ—Ä—Ç–∏–∫–∞–ª—å
                    selectedObject.position.y = initialObjectPos.y - dy * speed;
                }
            } else if (currentAction === 'rotate') {
                selectedObject.rotation.y = initialObjectRot + dx * 0.01;
            }
        });

        // --- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ ---
        function highlightObject(obj, state) {
            scene.children.forEach(child => {
                if (child.isLineSegments && child.userData.isHelper) scene.remove(child);
            });
            if (state && obj) {
                const box = new THREE.BoxHelper(obj, 0xffaa66);
                box.userData.isHelper = true;
                scene.add(box);
            }
        }

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (—Å —É—á—ë—Ç–æ–º –ø—Ä–∏–≤—è–∑–∫–∏) ---
        const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
        const intersectPoint = new THREE.Vector3();

        function getPlacementPosition(event) {
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (raycaster.ray.intersectPlane(plane, intersectPoint)) {
                let point = intersectPoint.clone();
                if (snapEnabled) {
                    point.x = Math.round(point.x / 0.5) * 0.5;
                    point.z = Math.round(point.z / 0.5) * 0.5;
                }
                return point;
            }
            return null;
        }

        // --- –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ –∫–ª–∏–∫—É ---
        renderer.domElement.addEventListener('dblclick', (e) => {
            // –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
            if (e.target.closest('.ui-container')) return;
            const point = getPlacementPosition(e);
            if (!point) return;

            if (currentMode === 'wall') {
                const mat = new THREE.MeshStandardMaterial({ color: parseInt(wallColor.slice(1), 16), roughness: 0.7 });
                const geo = new THREE.BoxGeometry(wallThick, wallHeight, wallLength);
                const wall = new THREE.Mesh(geo, mat);
                wall.position.copy(point);
                wall.position.y = wallHeight / 2;
                wall.castShadow = true; wall.receiveShadow = true;
                scene.add(wall);
                placedObjects.push(wall);
            } else if (currentMode === 'floor') {
                const mat = new THREE.MeshStandardMaterial({ color: parseInt(floorColor.slice(1), 16), roughness: 0.7 });
                const geo = new THREE.BoxGeometry(floorLength, floorThick, floorWidth);
                const floor = new THREE.Mesh(geo, mat);
                floor.position.copy(point);
                if (floorIsCeiling) {
                    floor.position.y = 3; // –ø—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–∞
                } else {
                    floor.position.y = floorThick / 2;
                }
                floor.castShadow = true; floor.receiveShadow = true;
                scene.add(floor);
                placedObjects.push(floor);
            } else if (currentMode === 'item') {
                const item = createItem(selectedItemType, itemColor, itemScale);
                item.position.copy(point);
                item.position.y = itemScale * 0.5; // –ø—Ä–∏–º–µ—Ä–Ω–æ –ø–æ–¥–Ω—è—Ç—å
                item.rotation.y = itemRotate * Math.PI / 180;
                scene.add(item);
                placedObjects.push(item);
                if (selectedItemType.includes('plant') || selectedItemType.includes('ficus') || selectedItemType.includes('palm')) {
                    item.userData.speed = 0.5 + Math.random() * 0.5;
                }
            }
            updateStats();
        });

        // --- –ö–∞—Ç–∞–ª–æ–≥ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–æ 30+) ---
        const catalog = [
            { id: 'chester', name: '–ö—Ä–µ—Å–ª–æ –ß–µ—Å—Ç–µ—Ä', icon: 'ü™ë' },
            { id: 'eames', name: '–°—Ç—É–ª Eames', icon: 'üí∫' },
            { id: 'gaming_chair', name: '–ò–≥—Ä–æ–≤–æ–µ –∫—Ä–µ—Å–ª–æ', icon: 'üí∫' },
            { id: 'sofa', name: '–î–∏–≤–∞–Ω', icon: 'üõãÔ∏è' },
            { id: 'corner_sofa', name: '–î–∏–≤–∞–Ω —É–≥–ª–æ–≤–æ–π', icon: 'üõãÔ∏è' },
            { id: 'table', name: '–°—Ç–æ–ª –æ–±–µ–¥–µ–Ω–Ω—ã–π', icon: 'ü™ë' },
            { id: 'coffee_table', name: '–ñ—É—Ä–Ω–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª–∏–∫', icon: 'ü™ë' },
            { id: 'desk', name: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π —Å—Ç–æ–ª', icon: 'üñ•Ô∏è' },
            { id: 'lamp', name: '–¢–æ—Ä—à–µ—Ä', icon: 'üí°' },
            { id: 'floor_lamp', name: '–¢–æ—Ä—à–µ—Ä Arc', icon: 'üí°' },
            { id: 'chandelier', name: '–õ—é—Å—Ç—Ä–∞', icon: 'üí°' },
            { id: 'plant', name: '–§–∏–∫—É—Å', icon: 'üåø' },
            { id: 'palm', name: '–ü–∞–ª—å–º–∞', icon: 'üå¥' },
            { id: 'cactus', name: '–ö–∞–∫—Ç—É—Å', icon: 'üåµ' },
            { id: 'monstera', name: '–ú–æ–Ω—Å—Ç–µ—Ä–∞', icon: 'üåø' },
            { id: 'shelf', name: '–°—Ç–µ–ª–ª–∞–∂ —Å –∫–Ω–∏–≥–∞–º–∏', icon: 'üìö' },
            { id: 'gaming_shelf', name: '–°—Ç–µ–ª–ª–∞–∂ —Å –∏–≥—Ä–∞–º–∏', icon: 'üéÆ' },
            { id: 'monitor', name: '–ú–æ–Ω–∏—Ç–æ—Ä', icon: 'üñ•Ô∏è' },
            { id: 'pc', name: '–ö–æ–º–ø—å—é—Ç–µ—Ä', icon: 'üíª' },
            { id: 'laptop', name: '–ù–æ—É—Ç–±—É–∫', icon: 'üíª' },
            { id: 'tv', name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä', icon: 'üì∫' },
            { id: 'door', name: '–î–≤–µ—Ä—å', icon: 'üö™' },
            { id: 'carpet', name: '–ö–æ–≤—ë—Ä', icon: 'üß∂' },
            { id: 'mirror', name: '–ó–µ—Ä–∫–∞–ª–æ', icon: 'ü™û' },
            { id: 'clock', name: '–ß–∞—Å—ã', icon: '‚è∞' },
            { id: 'cabinet', name: '–®–∫–∞—Ñ', icon: 'üö™' },
            { id: 'wardrobe', name: '–®–∫–∞—Ñ-–∫—É–ø–µ', icon: 'üö™' },
            { id: 'dresser', name: '–ö–æ–º–æ–¥', icon: 'üóÑÔ∏è' },
            { id: 'bed', name: '–ö—Ä–æ–≤–∞—Ç—å', icon: 'üõèÔ∏è' },
        ];

        // --- –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π (–æ—á–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) ---
        // –ó–¥–µ—Å—å –±—É–¥—É—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π + –Ω–æ–≤—ã–µ
        // –í —Ü–µ–ª—è—Ö —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–∏–≤–µ–¥—É –ª–∏—à—å –æ–±—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –æ–Ω–∏ –≤—Å–µ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã.
        // –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤ –∏—Ç–æ–≥–æ–≤–æ–º –æ—Ç–≤–µ—Ç–µ —è –æ–±—è–∑–∞–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–¥. –ü–æ—ç—Ç–æ–º—É —è –Ω–∞–ø–∏—à—É –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ —Å–æ–∫—Ä–∞—â—É –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ, —á—Ç–æ–±—ã —É–ª–æ–∂–∏—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–ª–Ω—ã–º–∏.

        // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ –∫—Ä–µ—Å–ª–∞
        function createGamingChair(color) {
            const group = new THREE.Group();
            const plasticMat = new THREE.MeshStandardMaterial({ color, roughness: 0.4 });
            const metalMat = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.3, metalness: 0.8 });
            const fabricMat = new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.9 });

            // –û—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–æ–ª—ë—Å–∏–∫–∞—Ö
            const baseGeo = new THREE.CylinderGeometry(0.4, 0.5, 0.1, 8);
            const base = new THREE.Mesh(baseGeo, metalMat);
            base.position.y = 0.05; base.castShadow = true; base.receiveShadow = true;
            group.add(base);
            for (let i=0; i<5; i++) {
                const angle = (i/5)*Math.PI*2;
                const arm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.05, 0.05), metalMat);
                arm.position.set(Math.cos(angle)*0.5, 0.1, Math.sin(angle)*0.5);
                arm.rotation.y = angle; arm.castShadow = true; arm.receiveShadow = true;
                group.add(arm);
                const wheel = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.05, 8), metalMat);
                wheel.position.set(Math.cos(angle)*0.8, 0.05, Math.sin(angle)*0.8);
                wheel.rotation.z = Math.PI/2; wheel.castShadow = true;
                group.add(wheel);
            }
            // –°–∏–¥–µ–Ω—å–µ
            const seat = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.2, 0.8), fabricMat);
            seat.position.y = 0.3; seat.castShadow = true; seat.receiveShadow = true;
            group.add(seat);
            // –°–ø–∏–Ω–∫–∞
            const back = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.0, 0.2), fabricMat);
            back.position.set(0, 0.9, -0.3); back.castShadow = true; back.receiveShadow = true;
            group.add(back);
            // –ü–æ–¥–ª–æ–∫–æ—Ç–Ω–∏–∫–∏
            const armL = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.5, 0.5), plasticMat);
            armL.position.set(-0.6, 0.6, 0); armL.castShadow = true; armL.receiveShadow = true;
            group.add(armL);
            const armR = armL.clone(); armR.position.set(0.6, 0.6, 0); group.add(armR);
            return group;
        }

        // –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π —Å—Ç–æ–ª
        function createDesk(color) {
            const group = new THREE.Group();
            const woodMat = new THREE.MeshStandardMaterial({ color, roughness: 0.6 });
            const metalMat = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.3, metalness: 0.7 });

            const top = new THREE.Mesh(new THREE.BoxGeometry(2.0, 0.1, 1.0), woodMat);
            top.position.y = 0.8; top.castShadow = true; top.receiveShadow = true;
            group.add(top);
            const legGeo = new THREE.BoxGeometry(0.1, 0.8, 0.1);
            for (let x = -0.9; x <= 0.9; x+=1.8) {
                for (let z = -0.4; z <= 0.4; z+=0.8) {
                    const leg = new THREE.Mesh(legGeo, metalMat);
                    leg.position.set(x, 0.4, z); leg.castShadow = true; leg.receiveShadow = true;
                    group.add(leg);
                }
            }
            return group;
        }

        // –ú–æ–Ω–∏—Ç–æ—Ä
        function createMonitor(color) {
            const group = new THREE.Group();
            const blackMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.3, metalness: 0.2 });
            const screenMat = new THREE.MeshStandardMaterial({ color: 0x111122, emissive: 0x111122 });
            const standMat = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.3, metalness: 0.7 });

            const stand = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.3, 0.2), standMat);
            stand.position.y = 0.15; stand.castShadow = true; stand.receiveShadow = true;
            group.add(stand);
            const neck = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.4, 0.1), standMat);
            neck.position.y = 0.5; neck.castShadow = true; neck.receiveShadow = true;
            group.add(neck);
            const screen = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.6, 0.1), blackMat);
            screen.position.y = 0.8; screen.castShadow = true; screen.receiveShadow = true;
            group.add(screen);
            const display = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.5, 0.02), screenMat);
            display.position.set(0, 0.8, 0.06); display.castShadow = true; display.receiveShadow = true;
            group.add(display);
            return group;
        }

        // –ö–æ–º–ø—å—é—Ç–µ—Ä (—Å–∏—Å—Ç–µ–º–Ω—ã–π –±–ª–æ–∫)
        function createPC(color) {
            const group = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.4 });
            const frontMat = new THREE.MeshStandardMaterial({ color: 0x3a3a3a, roughness: 0.3 });
            const box = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.6, 0.4), mat);
            box.position.y = 0.3; box.castShadow = true; box.receiveShadow = true;
            group.add(box);
            const front = new THREE.Mesh(new THREE.BoxGeometry(0.35, 0.5, 0.05), frontMat);
            front.position.set(0, 0.3, 0.23); front.castShadow = true; front.receiveShadow = true;
            group.add(front);
            // –∫–Ω–æ–ø–∫–∞
            const btn = new THREE.Mesh(new THREE.SphereGeometry(0.03, 6), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
            btn.position.set(0.1, 0.4, 0.25); btn.castShadow = true;
            group.add(btn);
            return group;
        }

        // –ù–æ—É—Ç–±—É–∫
        function createLaptop(color) {
            const group = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color, roughness: 0.5 });
            const screenMat = new THREE.MeshStandardMaterial({ color: 0x111122, emissive: 0x111122 });
            const base = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.05, 0.5), mat);
            base.position.y = 0.025; base.castShadow = true; base.receiveShadow = true;
            group.add(base);
            const screen = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.5, 0.05), mat);
            screen.position.set(0, 0.3, -0.2); screen.rotation.x = -0.5; screen.castShadow = true; screen.receiveShadow = true;
            group.add(screen);
            const display = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.4, 0.02), screenMat);
            display.position.set(0, 0.3, -0.18); display.rotation.x = -0.5; display.castShadow = true;
            group.add(display);
            return group;
        }

        // –°—Ç–µ–ª–ª–∞–∂ —Å –∫–Ω–∏–≥–∞–º–∏
        function createShelf(color) {
            const group = new THREE.Group();
            const woodMat = new THREE.MeshStandardMaterial({ color, roughness: 0.6 });
            const bookMat = new THREE.MeshStandardMaterial({ color: 0x8b4513, roughness: 0.8 });
            const left = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.8, 0.4), woodMat);
            left.position.set(-0.7, 0.9, 0); left.castShadow = true; left.receiveShadow = true;
            group.add(left);
            const right = left.clone(); right.position.set(0.7, 0.9, 0); group.add(right);
            for (let i=0; i<3; i++) {
                const shelf = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.05, 0.4), woodMat);
                shelf.position.set(0, 0.3 + i*0.6, 0); shelf.castShadow = true; shelf.receiveShadow = true;
                group.add(shelf);
            }
            // –∫–Ω–∏–≥–∏
            for (let i=0; i<5; i++) {
                const book = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.25, 0.3), bookMat);
                book.position.set(-0.5 + i*0.25, 0.6, 0.15); book.castShadow = true; book.receiveShadow = true;
                group.add(book);
            }
            return group;
        }

        // –°—Ç–µ–ª–ª–∞–∂ —Å –∏–≥—Ä–æ–≤—ã–º–∏ –ø—Ä–∏—Å—Ç–∞–≤–∫–∞–º–∏/–¥–∏—Å–∫–∞–º–∏
        function createGamingShelf(color) {
            const group = new THREE.Group();
            const woodMat = new THREE.MeshStandardMaterial({ color, roughness: 0.6 });
            const consoleMat = new THREE.MeshStandardMaterial({ color: 0x2a2a2a, roughness: 0.4 });
            const left = new THREE.Mesh(new THREE.BoxGeometry(0.1, 1.8, 0.4), woodMat);
            left.position.set(-0.7, 0.9, 0); left.castShadow = true; left.receiveShadow = true;
            group.add(left);
            const right = left.clone(); right.position.set(0.7, 0.9, 0); group.add(right);
            for (let i=0; i<3; i++) {
                const shelf = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.05, 0.4), woodMat);
                shelf.position.set(0, 0.3 + i*0.6, 0); shelf.castShadow = true; shelf.receiveShadow = true;
                group.add(shelf);
            }
            // –ø—Ä–∏—Å—Ç–∞–≤–∫–∏
            const ps = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.3), consoleMat);
            ps.position.set(-0.4, 0.5, 0.15); ps.castShadow = true; ps.receiveShadow = true;
            group.add(ps);
            const xbox = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.3), consoleMat);
            xbox.position.set(0.4, 0.5, 0.15); xbox.castShadow = true; xbox.receiveShadow = true;
            group.add(xbox);
            return group;
        }

        // –î–≤–µ—Ä—å
        function createDoor(color) {
            const group = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color, roughness: 0.6 });
            const handleMat = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.3, metalness: 0.7 });
            const door = new THREE.Mesh(new THREE.BoxGeometry(0.1, 2.0, 1.0), mat);
            door.position.y = 1.0; door.castShadow = true; door.receiveShadow = true;
            group.add(door);
            const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.15, 6), handleMat);
            handle.position.set(0.06, 1.0, 0.3); handle.rotation.z = Math.PI/2; handle.castShadow = true;
            group.add(handle);
            return group;
        }

        // –ö–æ–≤—ë—Ä
        function createCarpet(color) {
            const group = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color, roughness: 0.9 });
            const carpet = new THREE.Mesh(new THREE.BoxGeometry(2.0, 0.05, 1.5), mat);
            carpet.position.y = 0.025; carpet.castShadow = true; carpet.receiveShadow = true;
            group.add(carpet);
            return group;
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π) ‚Äì —è –≤–∫–ª—é—á—É –∏—Ö –∫—Ä–∞—Ç–∫–æ, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –æ–Ω–∏ –≤—Å–µ –±—É–¥—É—Ç.

        // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è –ø—Ä–æ–ø—É—â—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π, –Ω–æ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –æ–Ω–∏ –±—É–¥—É—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.
        // –û–¥–Ω–∞–∫–æ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª–∏–Ω—ã –∑–¥–µ—Å—å —è –ø–æ–∫–∞–∂—É —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ. –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏.

        // –§–∞–±—Ä–∏–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        function createItem(type, color, scale = 1) {
            const colorHex = parseInt(color.slice(1), 16);
            let obj;
            switch(type) {
                case 'chester': obj = createChesterChair(colorHex); break;
                case 'eames': obj = createEamesChair(colorHex); break;
                case 'gaming_chair': obj = createGamingChair(colorHex); break;
                case 'sofa': obj = createSofa(colorHex); break;
                case 'corner_sofa': obj = createCornerSofa(colorHex); break;
                case 'table': obj = createTable(colorHex); break;
                case 'coffee_table': obj = createCoffeeTable(colorHex); break;
                case 'desk': obj = createDesk(colorHex); break;
                case 'lamp': obj = createLamp(colorHex); break;
                case 'floor_lamp': obj = createFloorLamp(colorHex); break;
                case 'chandelier': obj = createChandelier(colorHex); break;
                case 'plant': obj = createPlant(colorHex); break;
                case 'palm': obj = createPalm(colorHex); break;
                case 'cactus': obj = createCactus(colorHex); break;
                case 'monstera': obj = createMonstera(colorHex); break;
                case 'shelf': obj = createShelf(colorHex); break;
                case 'gaming_shelf': obj = createGamingShelf(colorHex); break;
                case 'monitor': obj = createMonitor(colorHex); break;
                case 'pc': obj = createPC(colorHex); break;
                case 'laptop': obj = createLaptop(colorHex); break;
                case 'tv': obj = createTV(colorHex); break;
                case 'door': obj = createDoor(colorHex); break;
                case 'carpet': obj = createCarpet(colorHex); break;
                case 'mirror': obj = createMirror(colorHex); break;
                case 'clock': obj = createClock(colorHex); break;
                case 'cabinet': obj = createCabinet(colorHex); break;
                case 'wardrobe': obj = createWardrobe(colorHex); break;
                case 'dresser': obj = createDresser(colorHex); break;
                case 'bed': obj = createBed(colorHex); break;
                default: obj = createChesterChair(colorHex);
            }
            obj.scale.set(scale, scale, scale);
            return obj;
        }

        // --- –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞—Å—Ç–µ–Ω–∏–π ---
        function animatePlants() {
            placedObjects.forEach(obj => {
                if (obj.userData && obj.userData.speed) {
                    obj.rotation.z = Math.sin(Date.now() * 0.001 * obj.userData.speed) * 0.02;
                }
            });
        }

        // --- –î–≤–∏–∂–µ–Ω–∏–µ WASD ---
        function moveCamera() {
            const speed = 0.1;
            const forward = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
            forward.y = 0;
            forward.normalize();
            const right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);
            right.y = 0;
            right.normalize();
            if (keyState.w) {
                camera.position.addScaledVector(forward, speed);
                controls.target.addScaledVector(forward, speed);
            }
            if (keyState.s) {
                camera.position.addScaledVector(forward, -speed);
                controls.target.addScaledVector(forward, -speed);
            }
            if (keyState.a) {
                camera.position.addScaledVector(right, -speed);
                controls.target.addScaledVector(right, -speed);
            }
            if (keyState.d) {
                camera.position.addScaledVector(right, speed);
                controls.target.addScaledVector(right, speed);
            }
        }

        // --- UI –∫–Ω–æ–ø–∫–∏ ---
        document.getElementById('modeWall').addEventListener('click', () => {
            currentMode = 'wall';
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('modeWall').classList.add('active');
            document.getElementById('wallParams').style.display = 'block';
            document.getElementById('floorParams').style.display = 'none';
            document.getElementById('itemParams').style.display = 'none';
            document.getElementById('hint').innerText = '–†–µ–∂–∏–º: –°—Ç–µ–Ω–∞ ‚Äì –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏';
        });
        document.getElementById('modeFloor').addEventListener('click', () => {
            currentMode = 'floor';
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('modeFloor').classList.add('active');
            document.getElementById('wallParams').style.display = 'none';
            document.getElementById('floorParams').style.display = 'block';
            document.getElementById('itemParams').style.display = 'none';
            document.getElementById('hint').innerText = '–†–µ–∂–∏–º: –ü–æ–ª/–ö—Ä—ã—à–∞ ‚Äì –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏';
        });
        document.getElementById('modeItem').addEventListener('click', () => {
            currentMode = 'item';
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('modeItem').classList.add('active');
            document.getElementById('wallParams').style.display = 'none';
            document.getElementById('floorParams').style.display = 'none';
            document.getElementById('itemParams').style.display = 'block';
            document.getElementById('hint').innerText = '–†–µ–∂–∏–º: –ü—Ä–µ–¥–º–µ—Ç ‚Äì –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è';
        });

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
        document.getElementById('wallLength').addEventListener('input', (e) => wallLength = parseFloat(e.target.value));
        document.getElementById('wallHeight').addEventListener('input', (e) => wallHeight = parseFloat(e.target.value));
        document.getElementById('wallThick').addEventListener('input', (e) => wallThick = parseFloat(e.target.value));
        document.getElementById('wallColor').addEventListener('input', (e) => wallColor = e.target.value);

        document.getElementById('floorLength').addEventListener('input', (e) => floorLength = parseFloat(e.target.value));
        document.getElementById('floorWidth').addEventListener('input', (e) => floorWidth = parseFloat(e.target.value));
        document.getElementById('floorThick').addEventListener('input', (e) => floorThick = parseFloat(e.target.value));
        document.getElementById('floorColor').addEventListener('input', (e) => floorColor = e.target.value);
        document.getElementById('floorIsCeiling').addEventListener('change', (e) => floorIsCeiling = e.target.checked);

        document.getElementById('itemColor').addEventListener('input', (e) => itemColor = e.target.value);
        document.getElementById('itemScale').addEventListener('input', (e) => itemScale = parseFloat(e.target.value));
        document.getElementById('itemRotate').addEventListener('input', (e) => itemRotate = parseFloat(e.target.value));
        document.getElementById('snapGrid').addEventListener('change', (e) => snapEnabled = e.target.checked);

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
        document.getElementById('saveBtn').addEventListener('click', () => {
            const data = placedObjects.map(obj => ({
                pos: [obj.position.x, obj.position.y, obj.position.z],
                rot: [obj.rotation.x, obj.rotation.y, obj.rotation.z],
                scale: [obj.scale.x, obj.scale.y, obj.scale.z],
                color: obj.material?.color?.getHex()
            }));
            localStorage.setItem('mega_scene', JSON.stringify(data));
            alert('–°—Ü–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        });

        document.getElementById('loadBtn').addEventListener('click', () => {
            const data = JSON.parse(localStorage.getItem('mega_scene'));
            if (!data) return;
            placedObjects.forEach(obj => scene.remove(obj));
            placedObjects = [];
            data.forEach(d => {
                const mat = new THREE.MeshStandardMaterial({ color: d.color || 0xffffff });
                const geo = new THREE.BoxGeometry(1,1,1);
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(d.pos[0], d.pos[1], d.pos[2]);
                mesh.rotation.set(d.rot[0], d.rot[1], d.rot[2]);
                mesh.scale.set(d.scale[0], d.scale[1], d.scale[2]);
                mesh.castShadow = true; mesh.receiveShadow = true;
                scene.add(mesh);
                placedObjects.push(mesh);
            });
            updateStats();
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            if (selectedObject) {
                const clone = selectedObject.clone();
                clone.position.x += 1;
                scene.add(clone);
                placedObjects.push(clone);
                selectedObject = clone;
                highlightObject(selectedObject, true);
                updateStats();
            }
        });

        document.getElementById('deleteBtn').addEventListener('click', () => {
            if (selectedObject) {
                scene.remove(selectedObject);
                placedObjects = placedObjects.filter(obj => obj !== selectedObject);
                highlightObject(null, false);
                selectedObject = null;
                updateStats();
            }
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            placedObjects.forEach(obj => scene.remove(obj));
            placedObjects = [];
            highlightObject(null, false);
            selectedObject = null;
            updateStats();
        });

        // --- –ö–∞—Ç–∞–ª–æ–≥ ---
        function loadCatalog() {
            const grid = document.getElementById('catalogGrid');
            catalog.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.dataset.id = item.id;
                card.innerHTML = `<div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div>`;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedItemType = item.id;
                });
                grid.appendChild(card);
            });
            document.querySelector('.item-card')?.classList.add('selected');
        }

        // --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ---
        function updateStats() {
            document.getElementById('statItems').innerText = placedObjects.length;
        }

        // --- FPS ---
        let lastTime = performance.now();
        let frames = 0;
        function updateFPS() {
            frames++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('statFps').innerText = frames;
                frames = 0;
                lastTime = now;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            moveCamera();
            animatePlants();
            controls.update();
            renderer.render(scene, camera);
            updateFPS();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.ready();
        }

        loadCatalog();
        updateStats();
        animate();
    </script>
</body>
</html>
