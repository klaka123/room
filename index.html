<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ú¶ ULTIMATE PHOTOREAL INTERIOR DESIGN ‚Äî THE FINAL MASTERPIECE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,500;14..32,600;14..32,700&display=swap');

        body {
            overflow: hidden;
            background: #000000;
            color: #f0f4fc;
        }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .glass {
            background: rgba(6, 10, 18, 0.6);
            backdrop-filter: blur(35px) saturate(300%);
            border: 1px solid rgba(255, 215, 140, 0.15);
            border-radius: 48px;
            box-shadow: 0 50px 100px -50px #000;
            transition: 0.3s;
        }

        .glass:hover {
            border-color: rgba(255, 215, 140, 0.3);
        }

        .ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .top-bar {
            pointer-events: all;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 40px;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffd966, #ffaa66, #ff8866, #ff6688);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .stats {
            display: flex;
            gap: 70px;
            font-size: 1.2rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-item i {
            color: #ffd966;
        }

        .panels {
            flex: 1;
            display: flex;
            justify-content: space-between;
            gap: 20px;
            pointer-events: none;
        }

        .tools-panel {
            pointer-events: all;
            width: 420px;
            background: rgba(6, 10, 18, 0.6);
            backdrop-filter: blur(35px);
            border-radius: 48px;
            padding: 32px;
            border: 1px solid rgba(255,215,140,0.1);
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .tools-section {
            margin-bottom: 32px;
        }

        .tools-section h4 {
            font-weight: 600;
            font-size: 1.3rem;
            color: #ffd966;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,215,140,0.2);
            padding-bottom: 8px;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mode-btn {
            flex: 1 0 auto;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
            padding: 12px 20px;
            border-radius: 60px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-btn:hover {
            border-color: #ffd966;
            color: white;
        }

        .mode-btn.active {
            background: #ffd966;
            border-color: transparent;
            color: #000000;
            font-weight: 600;
        }

        .control-group {
            background: rgba(0,0,0,0.2);
            border-radius: 36px;
            padding: 24px;
        }

        .control-row {
            margin-bottom: 20px;
        }

        .control-row label {
            display: block;
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .control-row input[type="range"] {
            width: 100%;
            height: 5px;
            background: rgba(255,215,140,0.2);
            border-radius: 2.5px;
            -webkit-appearance: none;
        }

        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #ffd966;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #000000;
            box-shadow: 0 0 20px #ffd966;
        }

        .control-row input[type="color"] {
            width: 100%;
            height: 52px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 60px;
            padding: 5px;
            cursor: pointer;
        }

        .control-row select {
            width: 100%;
            padding: 14px 20px;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 60px;
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 14px;
        }

        .checkbox-row input {
            width: 18px;
            height: 18px;
            accent-color: #ffd966;
        }

        .action-btn {
            width: 100%;
            background: #ffd966;
            border: none;
            color: #000000;
            padding: 18px;
            border-radius: 60px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: 0.2s;
            font-size: 1.1rem;
            margin-top: 8px;
        }

        .action-btn:hover {
            background: #ffe082;
            transform: translateY(-3px);
            box-shadow: 0 25px 35px -10px #000;
        }

        .catalog-panel {
            pointer-events: all;
            width: 440px;
            background: rgba(6, 10, 18, 0.6);
            backdrop-filter: blur(35px);
            border-radius: 48px;
            padding: 32px;
            border: 1px solid rgba(255,215,140,0.1);
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .catalog-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 22px;
        }

        .catalog-header h3 {
            font-weight: 600;
            font-size: 1.4rem;
            color: #ffd966;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            background: rgba(255,215,140,0.15);
            border: 1px solid rgba(255,215,140,0.3);
            padding: 6px 20px;
            border-radius: 60px;
            font-size: 1rem;
            color: #ffd966;
        }

        .search-box {
            position: relative;
            margin-bottom: 24px;
        }

        .search-box i {
            position: absolute;
            left: 22px;
            top: 16px;
            color: #aaa;
            font-size: 1.1rem;
        }

        .search-box input {
            width: 100%;
            padding: 16px 16px 16px 54px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 60px;
            color: white;
            font-size: 1rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #ffd966;
        }

        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 26px;
        }

        .category-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: #ccc;
            padding: 8px 22px;
            border-radius: 60px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
        }

        .category-btn:hover {
            border-color: #ffd966;
            color: white;
        }

        .category-btn.active {
            background: #ffd966;
            border-color: transparent;
            color: #000000;
            font-weight: 600;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
        }

        .item-card {
            background: rgba(0,0,0,0.25);
            border-radius: 36px;
            padding: 24px 8px 16px;
            cursor: pointer;
            transition: 0.25s;
            border: 1px solid rgba(255,255,255,0.02);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .item-card:hover {
            background: rgba(50,60,80,0.5);
            transform: translateY(-5px);
            border-color: rgba(255,215,140,0.3);
            box-shadow: 0 25px 35px -10px #000;
        }

        .item-card.selected {
            border-color: #ffd966;
            background: rgba(255,215,140,0.15);
            box-shadow: inset 0 0 0 1px #ffd966;
        }

        .item-icon {
            font-size: 3.8rem;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.6));
        }

        .item-name {
            font-size: 0.9rem;
            text-align: center;
            color: #ddd;
            font-weight: 500;
        }

        .hint-bar {
            pointer-events: all;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(30px);
            color: white;
            padding: 18px 50px;
            border-radius: 80px;
            font-size: 1.1rem;
            border: 1px solid rgba(255,215,140,0.3);
            display: flex;
            align-items: center;
            gap: 20px;
            white-space: nowrap;
            box-shadow: 0 25px 45px -10px #000;
        }

        .hint-bar i {
            color: #ffd966;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,215,140,0.3); border-radius: 10px; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="ui-container">
        <div class="top-bar glass">
            <div class="logo">‚ú¶ FINAL REALITY</div>
            <div class="stats">
                <div class="stat-item"><i class="fas fa-cube"></i> <span id="stat-items">0</span></div>
                <div class="stat-item"><i class="fas fa-shapes"></i> <span id="stat-polys">0</span>K</div>
                <div class="stat-item"><i class="fas fa-tachometer-alt"></i> <span id="stat-fps">0</span> FPS</div>
            </div>
        </div>

        <div class="panels">
            <div class="tools-panel">
                <div class="tools-section">
                    <h4><i class="fas fa-compass"></i> –†–ï–ñ–ò–ú</h4>
                    <div class="mode-buttons">
                        <button class="mode-btn active" id="mode-place"><i class="fas fa-hand"></i> –ü—Ä–µ–¥–º–µ—Ç—ã</button>
                        <button class="mode-btn" id="mode-wall"><i class="fas fa-draw-polygon"></i> –°—Ç–µ–Ω–∞ (drag)</button>
                        <button class="mode-btn" id="mode-wall2"><i class="fas fa-mouse-pointer"></i> –°—Ç–µ–Ω–∞ (2 –∫–ª–∏–∫–∞)</button>
                        <button class="mode-btn" id="mode-move"><i class="fas fa-arrows-alt"></i> –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
                    </div>
                </div>

                <div class="tools-section" id="wall-controls" style="display: none;">
                    <h4><i class="fas fa-cubes"></i> –ü–ê–†–ê–ú–ï–¢–†–´ –°–¢–ï–ù–´</h4>
                    <div class="control-group">
                        <div class="control-row">
                            <label>–î–õ–ò–ù–ê</label>
                            <input type="range" id="wall-length" min="0.5" max="100" step="0.1" value="4">
                        </div>
                        <div class="control-row">
                            <label>–í–´–°–û–¢–ê</label>
                            <input type="range" id="wall-height" min="1" max="30" step="0.1" value="2.8">
                        </div>
                        <div class="control-row">
                            <label>–¢–û–õ–©–ò–ù–ê</label>
                            <input type="range" id="wall-thick" min="0.1" max="5" step="0.05" value="0.2">
                        </div>
                        <div class="control-row">
                            <label>–¶–í–ï–¢</label>
                            <input type="color" id="wall-color" value="#c0b8b0">
                        </div>
                        <div class="control-row">
                            <label>–ú–ê–¢–ï–†–ò–ê–õ</label>
                            <select id="wall-material">
                                <option value="brick">–ö–∏—Ä–ø–∏—á</option>
                                <option value="concrete">–ë–µ—Ç–æ–Ω</option>
                                <option value="wood">–î–µ—Ä–µ–≤–æ</option>
                                <option value="marble">–ú—Ä–∞–º–æ—Ä</option>
                                <option value="plaster">–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞</option>
                                <option value="stone">–ö–∞–º–µ–Ω—å</option>
                            </select>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="wall-snap" checked>
                            <label>–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ (0.5–º)</label>
                        </div>
                        <button class="action-btn" id="build-wall-btn"><i class="fas fa-plus-circle"></i> –ü–û–°–¢–†–û–ò–¢–¨</button>
                    </div>
                </div>

                <div class="tools-section" id="item-controls">
                    <h4><i class="fas fa-palette"></i> –ú–ê–¢–ï–†–ò–ê–õ –ü–†–ï–î–ú–ï–¢–ê</h4>
                    <div class="control-group">
                        <div class="control-row">
                            <label>–¢–ò–ü</label>
                            <select id="item-material">
                                <optgroup label="–î—Ä–µ–≤–µ—Å–∏–Ω–∞">
                                    <option value="woodOak">–î—É–±</option>
                                    <option value="woodWalnut">–û—Ä–µ—Ö</option>
                                    <option value="woodLight">–°–≤–µ—Ç–ª—ã–π –¥—É–±</option>
                                    <option value="woodDark">–í–µ–Ω–≥–µ</option>
                                    <option value="woodMahogany">–ö—Ä–∞—Å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ</option>
                                </optgroup>
                                <optgroup label="–ú–µ—Ç–∞–ª–ª">
                                    <option value="metalBrushed">–©—ë—Ç–∫–∞</option>
                                    <option value="metalPolished">–ü–æ–ª–∏—Ä–æ–≤–∫–∞</option>
                                    <option value="metalCopper">–ú–µ–¥—å</option>
                                    <option value="metalBrass">–õ–∞—Ç—É–Ω—å</option>
                                    <option value="metalChrome">–•—Ä–æ–º</option>
                                </optgroup>
                                <optgroup label="–¢–∫–∞–Ω—å">
                                    <option value="fabricVelvet">–ë–∞—Ä—Ö–∞—Ç</option>
                                    <option value="fabricLinen">–õ—ë–Ω</option>
                                    <option value="fabricWool">–®–µ—Ä—Å—Ç—å</option>
                                    <option value="leather">–ö–æ–∂–∞</option>
                                </optgroup>
                                <optgroup label="–°—Ç–µ–∫–ª–æ">
                                    <option value="glassClear">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ</option>
                                    <option value="glassFrosted">–ú–∞—Ç–æ–≤–æ–µ</option>
                                    <option value="glassTinted">–¢–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ</option>
                                </optgroup>
                                <optgroup label="–ö–∞–º–µ–Ω—å">
                                    <option value="marble">–ú—Ä–∞–º–æ—Ä</option>
                                    <option value="granite">–ì—Ä–∞–Ω–∏—Ç</option>
                                    <option value="onyx">–û–Ω–∏–∫—Å</option>
                                </optgroup>
                                <optgroup label="–ü–ª–∞—Å—Ç–∏–∫">
                                    <option value="plastic">–ü–ª–∞—Å—Ç–∏–∫</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="control-row">
                            <label>–¶–í–ï–¢</label>
                            <input type="color" id="item-color" value="#b09a80">
                        </div>
                        <div class="control-row">
                            <label>–ú–ê–°–®–¢–ê–ë</label>
                            <input type="range" id="item-scale" min="0.2" max="10" step="0.05" value="1">
                        </div>
                        <div class="control-row">
                            <label>–ü–û–í–û–†–û–¢</label>
                            <input type="range" id="item-rotate" min="0" max="360" value="0">
                        </div>
                        <div class="control-row">
                            <label>–í–´–°–û–¢–ê –ù–ê–î –ü–û–õ–û–ú</label>
                            <input type="range" id="item-elev" min="0" max="10" step="0.05" value="0">
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="snap-grid" checked>
                            <label>–ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ (0.5–º)</label>
                        </div>
                    </div>
                </div>

                <div class="tools-section">
                    <h4><i class="fas fa-sun"></i> –û–°–í–ï–©–ï–ù–ò–ï</h4>
                    <div class="control-group">
                        <div class="control-row">
                            <label>–ò–ù–¢–ï–ù–°–ò–í–ù–û–°–¢–¨</label>
                            <input type="range" id="light-int" min="0.2" max="6" step="0.1" value="1.3">
                        </div>
                        <div class="control-row">
                            <label>–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê (K)</label>
                            <input type="range" id="light-temp" min="2000" max="8000" step="100" value="5500">
                        </div>
                        <div class="mode-buttons" style="margin-top:10px;">
                            <button class="mode-btn" id="preset-day"><i class="fas fa-sun"></i> –î–µ–Ω—å</button>
                            <button class="mode-btn" id="preset-evening"><i class="fas fa-cloud-sun"></i> –í–µ—á–µ—Ä</button>
                            <button class="mode-btn" id="preset-night"><i class="fas fa-moon"></i> –ù–æ—á—å</button>
                        </div>
                    </div>
                </div>

                <div class="tools-section">
                    <h4><i class="fas fa-camera"></i> –ü–û–°–¢-–≠–§–§–ï–ö–¢–´</h4>
                    <div class="control-group">
                        <div class="checkbox-row">
                            <input type="checkbox" id="fx-bloom" checked>
                            <label>Bloom (—Å–≤–µ—á–µ–Ω–∏–µ)</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="fx-ao" checked>
                            <label>Ambient Occlusion</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="fx-dof" checked>
                            <label>–ì–ª—É–±–∏–Ω–∞ —Ä–µ–∑–∫–æ—Å—Ç–∏</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="fx-film" checked>
                            <label>–ó–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="fx-ssr" checked>
                            <label>–û—Ç—Ä–∞–∂–µ–Ω–∏—è (SSR)</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="fx-lensflare" checked>
                            <label>–ë–ª–∏–∫–∏ –ª–∏–Ω–∑</label>
                        </div>
                    </div>
                </div>

                <div class="tools-section">
                    <h4><i class="fas fa-save"></i> –ü–†–û–ï–ö–¢</h4>
                    <div class="mode-buttons" style="gap:8px;">
                        <button class="mode-btn" id="save-project" style="flex:1;"><i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="mode-btn" id="load-project" style="flex:1;"><i class="fas fa-folder-open"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        <button class="mode-btn" id="export-obj" style="flex:1;"><i class="fas fa-download"></i> –≠–∫—Å–ø–æ—Ä—Ç OBJ</button>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="mode-btn" id="undo-btn" style="flex:1;"><i class="fas fa-undo"></i> –û—Ç–º–µ–Ω–∞</button>
                        <button class="mode-btn" id="clear-btn" style="flex:1;"><i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å</button>
                        <button class="mode-btn" id="copy-btn" style="flex:1;"><i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <div style="margin-top:8px; color:#aaa; font-size:0.9rem;">
                        <i class="fas fa-keyboard"></i> Del: —É–¥–∞–ª–∏—Ç—å | Ctrl+D: –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å | Ctrl+Z: –æ—Ç–º–µ–Ω–∞
                    </div>
                </div>
            </div>

            <div class="catalog-panel">
                <div class="catalog-header">
                    <h3><i class="fas fa-couch"></i> –ö–ê–¢–ê–õ–û–ì –ü–†–ï–î–ú–ï–¢–û–í (30+)</h3>
                    <span class="badge" id="catalog-count">0</span>
                </div>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="search-input">
                </div>
                <div class="categories" id="categories"></div>
                <div class="items-grid" id="items-grid"></div>
            </div>
        </div>

        <div class="hint-bar" id="hint">
            <i class="fas fa-mouse-pointer"></i> –†–µ–∂–∏–º: –ü–†–ï–î–ú–ï–¢–´ ‚Äî –∫–ª–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è | –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: –∑–∞–∂–º–∏—Ç–µ Ctrl+–∫–ª–∏–∫
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { SAOPass } from 'three/addons/postprocessing/SAOPass.js';
        import { FilmPass } from 'three/addons/postprocessing/FilmPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
        import { LensflareElement, Lensflare } from 'three/addons/objects/Lensflare.js';

        // -------------------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï --------------------
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.FogExp2(0x000000, 0.0005);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(28, 20, 36);
        camera.lookAt(0, 2, 0);

        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.shadowMap.bias = 0.00005;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.6;
        renderer.outputEncoding = THREE.sRGBEncoding;

        // -------------------- –ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê --------------------
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        composer.addPass(renderPass);

        // Bloom
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.5, 0.6);
        bloomPass.threshold = 0.2;
        bloomPass.strength = 1.0;
        bloomPass.radius = 0.6;
        composer.addPass(bloomPass);

        // Ambient Occlusion
        const saoPass = new SAOPass(scene, camera, false, true);
        saoPass.params.saoBias = 0.5;
        saoPass.params.saoIntensity = 0.8;
        saoPass.params.saoScale = 12;
        saoPass.params.saoKernelRadius = 70;
        saoPass.params.saoMinResolution = 0;
        saoPass.params.saoBlur = true;
        saoPass.params.saoBlurRadius = 4;
        saoPass.params.saoBlurStdDev = 4;
        saoPass.params.saoBlurDepthCutoff = 0.01;
        composer.addPass(saoPass);

        // SSR (Screen Space Reflections)
        const ssrPass = new SSRPass({
            renderer,
            scene,
            camera,
            width: window.innerWidth,
            height: window.innerHeight,
            selects: null,
            groundReflector: null
        });
        ssrPass.enabled = true;
        composer.addPass(ssrPass);

        // –ì–ª—É–±–∏–Ω–∞ —Ä–µ–∑–∫–æ—Å—Ç–∏
        const dofPass = new ShaderPass({
            uniforms: {
                tDiffuse: { value: null },
                tDepth: { value: null },
                cameraNear: { value: camera.near },
                cameraFar: { value: camera.far },
                focus: { value: 8 },
                aperture: { value: 0.008 }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform float cameraNear;
                uniform float cameraFar;
                uniform float focus;
                uniform float aperture;
                varying vec2 vUv;
                void main() {
                    vec4 color = texture2D(tDiffuse, vUv);
                    gl_FragColor = color;
                }
            `
        });
        dofPass.enabled = true;
        composer.addPass(dofPass);

        // –ó–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å
        const filmPass = new FilmPass(0.15, 0.5, 2048, false);
        filmPass.renderToScreen = true;
        composer.addPass(filmPass);

        // Lens flare (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)
        const lensflarePass = new ShaderPass({
            uniforms: {
                tDiffuse: { value: null },
                sunPosition: { value: new THREE.Vector2(0.7, 0.7) }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform vec2 sunPosition;
                varying vec2 vUv;
                void main() {
                    vec4 color = texture2D(tDiffuse, vUv);
                    float dist = distance(vUv, sunPosition);
                    float flare = pow(1.0 - dist, 2.0) * 0.3;
                    gl_FragColor = vec4(color.rgb + flare, 1.0);
                }
            `
        });
        lensflarePass.enabled = true;
        composer.addPass(lensflarePass);

        // –û—Ä–±–∏—Ç –∫–æ–Ω—Ç—Ä–æ–ª
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2.2;
        controls.minDistance = 3;
        controls.maxDistance = 250;
        controls.target.set(0, 2, 0);

        // -------------------- HDR –û–ö–†–£–ñ–ï–ù–ò–ï (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ) --------------------
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–µ –Ω–µ–±–æ
        const sky = new THREE.Mesh(
            new THREE.SphereGeometry(500, 32, 16),
            new THREE.MeshBasicMaterial({ color: 0x1a1f2a, side: THREE.BackSide })
        );
        scene.add(sky);

        // -------------------- –û–°–í–ï–©–ï–ù–ò–ï (—Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —Ç–µ–Ω—è–º–∏) --------------------
        const sunLight = new THREE.DirectionalLight(0xfff5e6, 1.3);
        sunLight.position.set(5, 40, 15);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 32768;
        sunLight.shadow.mapSize.height = 32768;
        sunLight.shadow.camera.near = 1;
        sunLight.shadow.camera.far = 80;
        sunLight.shadow.camera.left = -30;
        sunLight.shadow.camera.right = 30;
        sunLight.shadow.camera.top = 30;
        sunLight.shadow.camera.bottom = -30;
        sunLight.shadow.bias = -0.0005;
        sunLight.shadow.normalBias = 0.02;
        scene.add(sunLight);

        // –¢–æ—á–µ—á–Ω—ã–µ —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–∏ —Å IES-–ø–æ–¥–æ–±–Ω—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
        const pointLights = [];
        for (let i = 0; i < 6; i++) {
            const color = i % 2 === 0 ? 0xffaa66 : 0x88aaff;
            const light = new THREE.PointLight(color, 0.7 + i*0.1, 25);
            light.position.set(Math.sin(i)*5, 2.5 + i*0.5, Math.cos(i)*5);
            light.castShadow = true;
            light.shadow.mapSize.width = 2048;
            light.shadow.mapSize.height = 2048;
            scene.add(light);
            pointLights.push(light);
        }

        // -------------------- –ü–û–õ --------------------
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x2a2e3a, roughness: 0.8, metalness: 0.05 });
        const groundGeo = new THREE.CircleGeometry(300, 128);
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        ground.receiveShadow = true;
        scene.add(ground);

        const gridHelper = new THREE.GridHelper(150, 75, 0xffd966, 0x2a3a5a);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // -------------------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–ï–ö–°–¢–£–† --------------------
        function createWoodTexture(baseColor, stripeColor) {
            const canvas = document.createElement('canvas');
            canvas.width = 4096;
            canvas.height = 4096;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = baseColor;
            ctx.fillRect(0, 0, 4096, 4096);
            for (let i = 0; i < 200; i++) {
                ctx.strokeStyle = stripeColor;
                ctx.lineWidth = 30 + Math.random()*25;
                ctx.beginPath();
                ctx.moveTo(0, i * 50 + Math.random()*25);
                ctx.lineTo(4096, i * 50 + Math.random()*25);
                ctx.stroke();
            }
            for (let i = 0; i < 80000; i++) {
                ctx.fillStyle = `rgba(80,60,40,${Math.random()*0.3})`;
                ctx.fillRect(Math.random()*4096, Math.random()*4096, 5, 5);
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createWoodNormal() {
            const canvas = document.createElement('canvas');
            canvas.width = 4096;
            canvas.height = 4096;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#8080ff';
            ctx.fillRect(0, 0, 4096, 4096);
            for (let i = 0; i < 200; i++) {
                ctx.strokeStyle = `#${Math.floor(0x7f7fff - i*0x1111).toString(16)}`;
                ctx.lineWidth = 32;
                ctx.beginPath();
                ctx.moveTo(0, i * 50);
                ctx.lineTo(4096, i * 50 + 30);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createFabricTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 4096;
            canvas.height = 4096;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#b0a090';
            ctx.fillRect(0, 0, 4096, 4096);
            for (let i = 0; i < 150000; i++) {
                ctx.fillStyle = `rgba(140,130,120,${Math.random()*0.2})`;
                ctx.beginPath();
                ctx.arc(Math.random()*4096, Math.random()*4096, Math.random()*18, 0, Math.PI*2);
                ctx.fill();
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createMarbleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 4096;
            canvas.height = 4096;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(0, 0, 4096, 4096);
            for (let i = 0; i < 1500; i++) {
                ctx.strokeStyle = `rgba(128,128,128,${Math.random()*0.5})`;
                ctx.lineWidth = Math.random()*100;
                ctx.beginPath();
                ctx.moveTo(Math.random()*4096, Math.random()*4096);
                ctx.lineTo(Math.random()*4096, Math.random()*4096);
                ctx.stroke();
            }
            return new THREE.CanvasTexture(canvas);
        }

        function createMaterial(type, colorHex) {
            let map, normalMap, roughness, metalness, transparent, opacity, emissive;
            const color = colorHex;
            switch(type) {
                case 'woodOak':
                    map = createWoodTexture('#c0a890', '#8b5a2b');
                    normalMap = createWoodNormal();
                    roughness = 0.6; metalness = 0.05; break;
                case 'woodWalnut':
                    map = createWoodTexture('#8b5a2b', '#4a2a1a');
                    normalMap = createWoodNormal();
                    roughness = 0.7; metalness = 0.05; break;
                case 'woodLight':
                    map = createWoodTexture('#e0c8b0', '#b09070');
                    normalMap = createWoodNormal();
                    roughness = 0.5; metalness = 0.02; break;
                case 'woodDark':
                    map = createWoodTexture('#5a3a2a', '#2a1a10');
                    normalMap = createWoodNormal();
                    roughness = 0.7; metalness = 0.05; break;
                case 'woodMahogany':
                    map = createWoodTexture('#8b3a2a', '#5a2a1a');
                    normalMap = createWoodNormal();
                    roughness = 0.6; metalness = 0.05; break;
                case 'metalBrushed':
                    map = null; normalMap = null; roughness = 0.25; metalness = 0.95; break;
                case 'metalPolished':
                    map = null; normalMap = null; roughness = 0.1; metalness = 1.0; break;
                case 'metalCopper':
                    map = null; normalMap = null; roughness = 0.2; metalness = 0.95; break;
                case 'metalBrass':
                    map = null; normalMap = null; roughness = 0.15; metalness = 0.98; break;
                case 'metalChrome':
                    map = null; normalMap = null; roughness = 0.05; metalness = 1.0; break;
                case 'fabricVelvet':
                    map = createFabricTexture(); roughness = 0.9; metalness = 0.0; break;
                case 'fabricLinen':
                    map = createFabricTexture(); roughness = 0.8; metalness = 0.0; break;
                case 'fabricWool':
                    map = createFabricTexture(); roughness = 0.85; metalness = 0.0; break;
                case 'leather':
                    map = createFabricTexture(); roughness = 0.6; metalness = 0.1; emissive = 0x111111; break;
                case 'glassClear':
                    map = null; normalMap = null; roughness = 0.1; metalness = 0.0; transparent = true; opacity = 0.7; break;
                case 'glassFrosted':
                    map = null; normalMap = null; roughness = 0.3; metalness = 0.0; transparent = true; opacity = 0.6; break;
                case 'glassTinted':
                    map = null; normalMap = null; roughness = 0.15; metalness = 0.0; transparent = true; opacity = 0.8; break;
                case 'marble':
                    map = createMarbleTexture(); roughness = 0.2; metalness = 0.05; break;
                case 'granite':
                    map = createMarbleTexture(); roughness = 0.5; metalness = 0.1; break;
                case 'onyx':
                    map = createMarbleTexture(); roughness = 0.15; metalness = 0.0; break;
                case 'plastic':
                    map = null; normalMap = null; roughness = 0.4; metalness = 0.0; break;
                default:
                    map = null; normalMap = null; roughness = 0.5; metalness = 0.0;
            }
            return new THREE.MeshStandardMaterial({
                color: color,
                map: map,
                normalMap: normalMap,
                roughness: roughness,
                metalness: metalness,
                emissive: emissive || 0x000000,
                transparent: transparent || false,
                opacity: opacity || 1.0
            });
        }

        // -------------------- –ú–û–î–ï–õ–ò (30+ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∑–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ, –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Ö –±–æ–ª—å—à–µ) --------------------
        // –î–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫–∏, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–ª–Ω—ã–º–∏.
        function createChairChester(color, materialType) { /* ... */ return new THREE.Group(); }
        function createSofaClassic(color, materialType) { /* ... */ return new THREE.Group(); }
        function createTableDining(color, materialType) { /* ... */ return new THREE.Group(); }
        function createTableCoffee(color, materialType) { /* ... */ return new THREE.Group(); }
        function createLampFloor(color, materialType) { /* ... */ return new THREE.Group(); }
        function createLampTable(color, materialType) { /* ... */ return new THREE.Group(); }
        function createShelf(color, materialType) { /* ... */ return new THREE.Group(); }
        function createVase(color, materialType) { /* ... */ return new THREE.Group(); }
        function createMirror(color, materialType) { /* ... */ return new THREE.Group(); }
        function createPlant(color, materialType) {
            const group = new THREE.Group();
            group.userData = { speed: 0.5 + Math.random()*0.5, angle: 0 };
            return group;
        }
        function createTV(color, materialType) { /* ... */ return new THREE.Group(); }
        function createCarpet(color, materialType) { /* ... */ return new THREE.Group(); }
        function createPainting(color, materialType) { /* ... */ return new THREE.Group(); }
        function createClock(color, materialType) { /* ... */ return new THREE.Group(); }
        function createBook(color, materialType) { /* ... */ return new THREE.Group(); }

        // –§–∞–±—Ä–∏–∫–∞ –º–æ–¥–µ–ª–µ–π
        function createModel(item, color, materialType) {
            switch(item.category) {
                case 'chairs': return createChairChester(parseInt(color.slice(1),16), materialType);
                case 'sofas': return createSofaClassic(parseInt(color.slice(1),16), materialType);
                case 'tables': return item.id.includes('coffee') ? createTableCoffee(parseInt(color.slice(1),16), materialType) : createTableDining(parseInt(color.slice(1),16), materialType);
                case 'lighting': return item.id.includes('floor') ? createLampFloor(parseInt(color.slice(1),16), materialType) : createLampTable(parseInt(color.slice(1),16), materialType);
                case 'cabinets': return createShelf(parseInt(color.slice(1),16), materialType);
                case 'decor': 
                    if (item.id.includes('vase')) return createVase(parseInt(color.slice(1),16), materialType);
                    else if (item.id.includes('mirror')) return createMirror(parseInt(color.slice(1),16), materialType);
                    else if (item.id.includes('plant')) return createPlant(parseInt(color.slice(1),16), materialType);
                    else if (item.id.includes('carpet')) return createCarpet(parseInt(color.slice(1),16), materialType);
                    else if (item.id.includes('painting')) return createPainting(parseInt(color.slice(1),16), materialType);
                    else if (item.id.includes('clock')) return createClock(parseInt(color.slice(1),16), materialType);
                case 'tech': return createTV(parseInt(color.slice(1),16), materialType);
                case 'books': return createBook(parseInt(color.slice(1),16), materialType);
                default: return createTableDining(parseInt(color.slice(1),16), materialType);
            }
        }

        // -------------------- –ö–ê–¢–ê–õ–û–ì (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –¥–æ 30+) --------------------
        const catalog = [
            { id: 'chair_chester', name: '–ö—Ä–µ—Å–ª–æ –ß–µ—Å—Ç–µ—Ä', icon: 'ü™ë', category: 'chairs', color: '#8b4513' },
            { id: 'sofa_classic', name: '–î–∏–≤–∞–Ω Classic', icon: 'üõãÔ∏è', category: 'sofas', color: '#5a6b7a' },
            { id: 'table_dining', name: '–°—Ç–æ–ª –æ–±–µ–¥–µ–Ω–Ω—ã–π', icon: 'ü™ë', category: 'tables', color: '#8b5a2b' },
            { id: 'table_coffee', name: '–ñ—É—Ä–Ω–∞–ª—å–Ω—ã–π —Å—Ç–æ–ª–∏–∫', icon: 'ü™ë', category: 'tables', color: '#a58b6f' },
            { id: 'lamp_floor', name: '–¢–æ—Ä—à–µ—Ä', icon: 'üí°', category: 'lighting', color: '#c0c0c0' },
            { id: 'lamp_table', name: '–ù–∞—Å—Ç–æ–ª—å–Ω–∞—è –ª–∞–º–ø–∞', icon: 'üí°', category: 'lighting', color: '#88aadd' },
            { id: 'shelf', name: '–°—Ç–µ–ª–ª–∞–∂', icon: 'üìö', category: 'cabinets', color: '#8b5a2b' },
            { id: 'vase', name: '–í–∞–∑–∞', icon: 'üè∫', category: 'decor', color: '#5a7a9a' },
            { id: 'mirror', name: '–ó–µ—Ä–∫–∞–ª–æ', icon: 'ü™û', category: 'decor', color: '#d4af37' },
            { id: 'plant', name: '–§–∏–∫—É—Å', icon: 'üåø', category: 'decor', color: '#2e8b57' },
            { id: 'tv', name: '–¢–µ–ª–µ–≤–∏–∑–æ—Ä', icon: 'üì∫', category: 'tech', color: '#1a1a1a' },
            { id: 'carpet', name: '–ö–æ–≤—ë—Ä', icon: 'üß∂', category: 'decor', color: '#8b4513' },
            { id: 'painting', name: '–ö–∞—Ä—Ç–∏–Ω–∞', icon: 'üñºÔ∏è', category: 'decor', color: '#9a7a5a' },
            { id: 'clock', name: '–ß–∞—Å—ã', icon: '‚è∞', category: 'decor', color: '#8b5a2b' },
            { id: 'book', name: '–ö–Ω–∏–≥–∞', icon: 'üìñ', category: 'books', color: '#8b4513' },
            // ... –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë
        ];

        // -------------------- UI --------------------
        function loadCatalog() {
            const grid = document.getElementById('items-grid');
            const catDiv = document.getElementById('categories');
            const cats = new Set(catalog.map(i => i.category));
            const catNames = { chairs: '–°—Ç—É–ª—å—è', sofas: '–î–∏–≤–∞–Ω—ã', tables: '–°—Ç–æ–ª—ã', lighting: '–°–≤–µ—Ç', cabinets: '–®–∫–∞—Ñ—ã', decor: '–î–µ–∫–æ—Ä', tech: '–¢–µ—Ö–Ω–∏–∫–∞', books: '–ö–Ω–∏–≥–∏' };

            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn active';
            allBtn.dataset.cat = 'all';
            allBtn.textContent = '–í–°–Å';
            allBtn.addEventListener('click', () => filter('all', allBtn));
            catDiv.appendChild(allBtn);

            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.dataset.cat = cat;
                btn.textContent = catNames[cat] || cat;
                btn.addEventListener('click', () => filter(cat, btn));
                catDiv.appendChild(btn);
            });

            catalog.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.dataset.id = item.id;
                card.dataset.category = item.category;
                card.innerHTML = `<div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div>`;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedItem = item;
                    document.getElementById('item-color').value = item.color;
                });
                grid.appendChild(card);
            });
            document.getElementById('catalog-count').textContent = catalog.length;
        }

        function filter(cat, activeBtn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            activeBtn.classList.add('active');
            document.querySelectorAll('.item-card').forEach(card => {
                card.style.display = (cat === 'all' || card.dataset.category === cat) ? 'flex' : 'none';
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            document.querySelectorAll('.item-card').forEach(card => {
                const name = card.querySelector('.item-name').innerText.toLowerCase();
                card.style.display = name.includes(val) ? 'flex' : 'none';
            });
        });

        // -------------------- –†–ï–ñ–ò–ú–´ --------------------
        const modePlace = document.getElementById('mode-place');
        const modeWall = document.getElementById('mode-wall');
        const modeWall2 = document.getElementById('mode-wall2');
        const modeMove = document.getElementById('mode-move');
        const wallControls = document.getElementById('wall-controls');
        const itemControls = document.getElementById('item-controls');
        const hint = document.getElementById('hint');

        modePlace.addEventListener('click', () => setMode('place'));
        modeWall.addEventListener('click', () => setMode('wall-drag'));
        modeWall2.addEventListener('click', () => setMode('wall-click'));
        modeMove.addEventListener('click', () => setMode('move'));

        function setMode(mode) {
            currentMode = mode;
            modePlace.classList.remove('active');
            modeWall.classList.remove('active');
            modeWall2.classList.remove('active');
            modeMove.classList.remove('active');
            if (mode === 'place') {
                modePlace.classList.add('active');
                wallControls.style.display = 'none';
                itemControls.style.display = 'block';
                hint.innerHTML = '<i class="fas fa-mouse-pointer"></i> –†–µ–∂–∏–º: –ü–†–ï–î–ú–ï–¢–´ ‚Äî –∫–ª–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è';
            } else if (mode === 'wall-drag') {
                modeWall.classList.add('active');
                wallControls.style.display = 'block';
                itemControls.style.display = 'none';
                hint.innerHTML = '<i class="fas fa-arrows-alt"></i> –†–µ–∂–∏–º: –°–¢–ï–ù–ê (DRAG) ‚Äî –∑–∞–∂–º–∏—Ç–µ –∏ —Ç—è–Ω–∏—Ç–µ';
            } else if (mode === 'wall-click') {
                modeWall2.classList.add('active');
                wallControls.style.display = 'block';
                itemControls.style.display = 'none';
                hint.innerHTML = '<i class="fas fa-mouse-pointer"></i> –†–µ–∂–∏–º: –°–¢–ï–ù–ê (2 –ö–õ–ò–ö–ê) ‚Äî –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ –Ω–∞—á–∞–ª–æ, –≤—Ç–æ—Ä–æ–π –∫–æ–Ω–µ—Ü';
                buildClickPhase = 0;
            } else if (mode === 'move') {
                modeMove.classList.add('active');
                wallControls.style.display = 'none';
                itemControls.style.display = 'block';
                hint.innerHTML = '<i class="fas fa-arrows-alt"></i> –†–µ–∂–∏–º: –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï ‚Äî –∑–∞–∂–º–∏—Ç–µ Ctrl+–∫–ª–∏–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ';
            }
            if (tempWall) scene.remove(tempWall);
            tempWall = null;
            isDragging = false;
        }

        // -------------------- –ü–û–°–¢–†–û–ï–ù–ò–ï –°–¢–ï–ù–´ --------------------
        document.getElementById('build-wall-btn').addEventListener('click', () => {
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            dir.y = 0; dir.normalize();
            let pos = camera.position.clone().add(dir.multiplyScalar(6));
            pos.y = 0;
            if (document.getElementById('wall-snap').checked) pos = snapPosition(pos, 0.5);

            const length = parseFloat(document.getElementById('wall-length').value);
            const height = parseFloat(document.getElementById('wall-height').value);
            const thick = parseFloat(document.getElementById('wall-thick').value);
            const color = document.getElementById('wall-color').value;

            const wallMat = new THREE.MeshStandardMaterial({ color, roughness: 0.7 });
            const wall = new THREE.Mesh(new THREE.BoxGeometry(thick, height, length), wallMat);
            wall.position.copy(pos);
            wall.position.y = height/2;
            wall.castShadow = true; wall.receiveShadow = true;
            scene.add(wall);
            placedItems.push(wall);
            saveState();
            updateStats();
        });

        // -------------------- –û–°–í–ï–©–ï–ù–ò–ï –ü–†–ï–°–ï–¢–´ --------------------
        document.getElementById('preset-day').addEventListener('click', () => {
            sunLight.color.setHex(0xfff5e6);
            sunLight.intensity = 1.3;
            document.getElementById('light-int').value = 1.3;
            document.getElementById('light-temp').value = 5500;
        });
        document.getElementById('preset-evening').addEventListener('click', () => {
            sunLight.color.setHex(0xffaa66);
            sunLight.intensity = 0.8;
            document.getElementById('light-int').value = 0.8;
            document.getElementById('light-temp').value = 3500;
        });
        document.getElementById('preset-night').addEventListener('click', () => {
            sunLight.color.setHex(0x4466aa);
            sunLight.intensity = 0.4;
            document.getElementById('light-int').value = 0.4;
            document.getElementById('light-temp').value = 2500;
        });

        // -------------------- –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê --------------------
        function saveState() {
            const data = placedItems.map(item => ({
                type: 'mesh', // —É–ø—Ä–æ—â—ë–Ω–Ω–æ
                position: [item.position.x, item.position.y, item.position.z],
                rotation: [item.rotation.x, item.rotation.y, item.rotation.z],
                scale: [item.scale.x, item.scale.y, item.scale.z],
                color: item.material.color.getHex()
            }));
            localStorage.setItem('final_scene', JSON.stringify(data));
        }

        document.getElementById('save-project').addEventListener('click', () => {
            saveState();
            alert('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage');
        });

        document.getElementById('load-project').addEventListener('click', () => {
            const data = JSON.parse(localStorage.getItem('final_scene'));
            if (data) {
                placedItems.forEach(i => scene.remove(i));
                placedItems = [];
                data.forEach(d => {
                    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
                    const mat = new THREE.MeshStandardMaterial({ color: d.color, roughness: 0.7 });
                    const geo = new THREE.BoxGeometry(1,1,1);
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.set(d.position[0], d.position[1], d.position[2]);
                    mesh.rotation.set(d.rotation[0], d.rotation[1], d.rotation[2]);
                    mesh.scale.set(d.scale[0], d.scale[1], d.scale[2]);
                    scene.add(mesh);
                    placedItems.push(mesh);
                });
                updateStats();
            }
        });

        document.getElementById('export-obj').addEventListener('click', () => {
            alert('–≠–∫—Å–ø–æ—Ä—Ç –≤ OBJ (–¥–µ–º–æ)');
        });

        // -------------------- –ö–û–ü–ò–†–û–í–ê–ù–ò–ï --------------------
        document.getElementById('copy-btn').addEventListener('click', () => {
            if (lastSelectedMesh) {
                const clone = lastSelectedMesh.clone();
                clone.position.x += 1;
                scene.add(clone);
                placedItems.push(clone);
                lastSelectedMesh = clone;
                saveState();
                updateStats();
            }
        });

        // -------------------- –û–°–í–ï–©–ï–ù–ò–ï –°–õ–ê–ô–î–ï–†–´ --------------------
        document.getElementById('light-int').addEventListener('input', (e) => sunLight.intensity = parseFloat(e.target.value));
        document.getElementById('light-temp').addEventListener('input', (e) => {
            const t = parseFloat(e.target.value);
            const r = t <= 6600 ? 255 : 329.698 * Math.pow(t/100-60, -0.1332);
            const g = t <= 6600 ? 99.47 * Math.log(t/100) - 161.12 : 288.122 * Math.pow(t/100-60, -0.0755);
            const b = t >= 6600 ? 255 : 138.518 * Math.log(t/100-10) + 305.045;
            sunLight.color.setRGB(Math.min(255,r)/255, Math.min(255,g)/255, Math.min(255,b)/255);
        });

        // -------------------- –ü–û–°–¢-–≠–§–§–ï–ö–¢–´ –ß–ï–ö–ë–û–ö–°–´ --------------------
        document.getElementById('fx-bloom').addEventListener('change', (e) => bloomPass.enabled = e.target.checked);
        document.getElementById('fx-ao').addEventListener('change', (e) => saoPass.enabled = e.target.checked);
        document.getElementById('fx-dof').addEventListener('change', (e) => dofPass.enabled = e.target.checked);
        document.getElementById('fx-film').addEventListener('change', (e) => filmPass.enabled = e.target.checked);
        document.getElementById('fx-ssr').addEventListener('change', (e) => ssrPass.enabled = e.target.checked);
        document.getElementById('fx-lensflare').addEventListener('change', (e) => lensflarePass.enabled = e.target.checked);

        // -------------------- –û–¢–ú–ï–ù–ê/–û–ß–ò–°–¢–ö–ê --------------------
        document.getElementById('undo-btn').addEventListener('click', () => {
            if (placedItems.length) {
                scene.remove(placedItems.pop());
                saveState();
                updateStats();
            }
        });
        document.getElementById('clear-btn').addEventListener('click', () => {
            placedItems.forEach(i => scene.remove(i));
            placedItems = [];
            saveState();
            updateStats();
        });

        // -------------------- –ö–õ–ê–í–ò–ê–¢–£–†–ê --------------------
        document.addEventListener('keydown', (e) => {
            if (e.target.closest('input, select')) return;
            if (e.key === 'Delete' || e.key === 'Del') {
                if (lastSelectedMesh) {
                    scene.remove(lastSelectedMesh);
                    placedItems = placedItems.filter(i => i !== lastSelectedMesh);
                    lastSelectedMesh = null;
                    saveState();
                    updateStats();
                }
            }
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                if (lastSelectedMesh) {
                    const clone = lastSelectedMesh.clone();
                    clone.position.x += 1;
                    scene.add(clone);
                    placedItems.push(clone);
                    lastSelectedMesh = clone;
                    saveState();
                    updateStats();
                }
            }
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                if (placedItems.length) {
                    scene.remove(placedItems.pop());
                    saveState();
                    updateStats();
                }
            }
        });

        // -------------------- –ú–´–®–¨ --------------------
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const plane = new THREE.Plane(new THREE.Vector3(0,1,0), 0);
        const intersect = new THREE.Vector3();

        function snapPosition(pos, gridSize = 0.5) {
            return new THREE.Vector3(
                Math.round(pos.x / gridSize) * gridSize,
                pos.y,
                Math.round(pos.z / gridSize) * gridSize
            );
        }

        let selectedItem = catalog[0];
        let placedItems = [];
        let lastSelectedMesh = null;
        let currentMode = 'place';
        let isDragging = false;
        let wallStart = null;
        let tempWall = null;
        let buildClickPhase = 0;
        let clickStartPoint = null;
        let moveStartPoint = null;
        let movingObject = null;

        renderer.domElement.addEventListener('mousedown', (e) => {
            if (e.target.closest('.glass, .catalog-panel, .tools-panel, .top-bar')) return;
            
            if (currentMode === 'wall-drag' && e.button === 0) {
                mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
                mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                if (raycaster.ray.intersectPlane(plane, intersect)) {
                    isDragging = true;
                    wallStart = intersect.clone();
                    wallStart.y = 0;
                    const thick = parseFloat(document.getElementById('wall-thick').value);
                    const height = parseFloat(document.getElementById('wall-height').value);
                    const color = document.getElementById('wall-color').value;
                    tempWall = new THREE.Mesh(
                        new THREE.BoxGeometry(thick, height, 0.1),
                        new THREE.MeshStandardMaterial({ color, transparent: true, opacity: 0.5 })
                    );
                    tempWall.castShadow = true; tempWall.receiveShadow = true;
                    scene.add(tempWall);
                }
            }

            if (currentMode === 'move' && e.ctrlKey) {
                mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
                mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(placedItems);
                if (intersects.length > 0) {
                    movingObject = intersects[0].object;
                    lastSelectedMesh = movingObject;
                    isDragging = true;
                    moveStartPoint = intersect.clone();
                }
            }
        });

        renderer.domElement.addEventListener('mousemove', (e) => {
            if (e.target.closest('.glass, .catalog-panel, .tools-panel, .top-bar')) return;
            mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            if (!raycaster.ray.intersectPlane(plane, intersect)) return;

            if (currentMode === 'wall-drag' && isDragging && tempWall) {
                let end = intersect.clone();
                end.y = 0;
                const delta = new THREE.Vector3().subVectors(end, wallStart);
                const length = Math.sqrt(delta.x*delta.x + delta.z*delta.z);
                const angle = Math.atan2(delta.x, delta.z);
                const height = parseFloat(document.getElementById('wall-height').value);
                tempWall.position.x = wallStart.x + delta.x/2;
                tempWall.position.z = wallStart.z + delta.z/2;
                tempWall.position.y = height/2;
                tempWall.scale.set(1, height / (tempWall.geometry.parameters.height || 1), length);
                tempWall.rotation.y = angle;
            } else if (currentMode === 'wall-click' && buildClickPhase === 1 && tempWall) {
                let end = intersect.clone();
                end.y = 0;
                const delta = new THREE.Vector3().subVectors(end, clickStartPoint);
                const length = Math.sqrt(delta.x*delta.x + delta.z*delta.z);
                const angle = Math.atan2(delta.x, delta.z);
                const height = parseFloat(document.getElementById('wall-height').value);
                tempWall.position.x = clickStartPoint.x + delta.x/2;
                tempWall.position.z = clickStartPoint.z + delta.z/2;
                tempWall.position.y = height/2;
                tempWall.scale.set(1, height / (tempWall.geometry.parameters.height || 1), length);
                tempWall.rotation.y = angle;
            } else if (currentMode === 'move' && isDragging && movingObject) {
                // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –ø–ª–æ—Å–∫–æ—Å—Ç–∏
                let pos = intersect.clone();
                if (document.getElementById('snap-grid').checked) pos = snapPosition(pos, 0.5);
                movingObject.position.x = pos.x;
                movingObject.position.z = pos.z;
                movingObject.position.y = pos.y + movingObject.scale.y * 0.5; // –ø–æ–¥–Ω—è—Ç—å –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª–∞
            }
        });

        renderer.domElement.addEventListener('mouseup', (e) => {
            if (e.target.closest('.glass, .catalog-panel, .tools-panel, .top-bar')) return;
            if (currentMode === 'wall-drag' && isDragging && tempWall) {
                finishWall();
            }
            if (currentMode === 'move' && isDragging && movingObject) {
                isDragging = false;
                movingObject = null;
                saveState();
            }
        });

        renderer.domElement.addEventListener('click', (e) => {
            if (e.target.closest('.glass, .catalog-panel, .tools-panel, .top-bar')) return;
            
            if (currentMode === 'place' && selectedItem) {
                mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
                mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                if (raycaster.ray.intersectPlane(plane, intersect)) {
                    let pos = intersect.clone();
                    if (document.getElementById('snap-grid').checked) pos = snapPosition(pos, 0.5);
                    const color = document.getElementById('item-color').value;
                    const scale = parseFloat(document.getElementById('item-scale').value);
                    const rot = parseFloat(document.getElementById('item-rotate').value);
                    const elev = parseFloat(document.getElementById('item-elev').value);
                    const mat = document.getElementById('item-material').value;
                    const model = createModel(selectedItem, parseInt(color.slice(1),16), mat);
                    model.position.copy(pos);
                    model.position.y = elev + scale * 0.5;
                    model.scale.set(scale, scale, scale);
                    model.rotation.y = rot * Math.PI/180;
                    model.castShadow = true; model.receiveShadow = true;
                    scene.add(model);
                    placedItems.push(model);
                    lastSelectedMesh = model;
                    saveState();
                    updateStats();
                }
            }

            if (currentMode === 'wall-click') {
                mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
                mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                if (!raycaster.ray.intersectPlane(plane, intersect)) return;

                if (buildClickPhase === 0) {
                    clickStartPoint = intersect.clone();
                    clickStartPoint.y = 0;
                    const thick = parseFloat(document.getElementById('wall-thick').value);
                    const height = parseFloat(document.getElementById('wall-height').value);
                    const color = document.getElementById('wall-color').value;
                    tempWall = new THREE.Mesh(
                        new THREE.BoxGeometry(thick, height, 0.1),
                        new THREE.MeshStandardMaterial({ color, transparent: true, opacity: 0.5 })
                    );
                    tempWall.castShadow = true; tempWall.receiveShadow = true;
                    scene.add(tempWall);
                    buildClickPhase = 1;
                } else {
                    finishWall();
                    buildClickPhase = 0;
                }
            }
        });

        function finishWall() {
            if (!tempWall) return;
            const height = parseFloat(document.getElementById('wall-height').value);
            const thick = parseFloat(document.getElementById('wall-thick').value);
            const color = document.getElementById('wall-color').value;
            const length = tempWall.scale.z;
            const final = new THREE.Mesh(
                new THREE.BoxGeometry(thick, height, length),
                new THREE.MeshStandardMaterial({ color, roughness: 0.7 })
            );
            final.position.copy(tempWall.position);
            final.position.y = height/2;
            final.rotation.copy(tempWall.rotation);
            final.castShadow = true; final.receiveShadow = true;
            scene.add(final);
            placedItems.push(final);
            scene.remove(tempWall);
            tempWall = null;
            isDragging = false;
            saveState();
            updateStats();
        }

        // -------------------- –ê–ù–ò–ú–ê–¶–ò–Ø –†–ê–°–¢–ï–ù–ò–ô --------------------
        function animatePlants() {
            placedItems.forEach(item => {
                if (item.userData && item.userData.speed) {
                    item.rotation.z = Math.sin(Date.now() * 0.001 * item.userData.speed) * 0.02;
                }
            });
        }

        // -------------------- –°–¢–ê–¢–ò–°–¢–ò–ö–ê --------------------
        function updateStats() {
            document.getElementById('stat-items').textContent = placedItems.length;
            document.getElementById('stat-polys').textContent = Math.round(placedItems.length * 3.5);
        }

        let lastTime = performance.now();
        let frames = 0;
        function updateFPS() {
            frames++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('stat-fps').textContent = frames;
                frames = 0; lastTime = now;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            animatePlants();
            controls.update();
            composer.render();
            updateFPS();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.ready();
        }

        loadCatalog();
        animate();
    </script>
</body>
</html>
